<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ibagu√© v2 ‚Äî Comunas (13) y Corregimientos (17) con poblaci√≥n</title>
  <meta name="description" content="Mapa de Ibagu√© con comunas y corregimientos. Etiquetas grandes, puntos transparentes y badge de poblaci√≥n para ambas capas. Carga JSON externo con fallback inline." />

  <!-- 1) Leaflet: CSS local ‚Üí fallback CDN autom√°tico -->
  <link rel="stylesheet" href="assets/leaflet/leaflet.css" id="leafletCSSLocal" />
  <style>
    :root{ --label-font-size: 28px; --badge-alpha: .45 }
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background:#0b1020; color:#e8eef7; }
    #app { display:flex; flex-direction:column; height:100%; }
    header { padding: 10px 12px; background: #121a33; border-bottom: 1px solid #1f2a4d; display:flex; gap:12px; align-items:center; flex-wrap: wrap; position:sticky; top:0; z-index:10 }
    header h1 { font-size: 18px; margin:0; font-weight:700; letter-spacing:.2px; }
    header .pill { background: #0f1730; border:1px solid #27335f; padding:8px 10px; border-radius: 14px; display:flex; gap:8px; align-items:center; }
    label { font-size: 13px; color:#b6c3e4; }
    select, input[type="range"], input[type="text"]{ background:#0a1228; color:#e8eef7; border:1px solid #283562; border-radius:10px; padding:6px 8px; }
    #map { flex:1; width:100%; }
    .leaflet-container { background: #081022; }

    /* Etiquetas grandes y legibles */
    .marker-label { font-size: var(--label-font-size); font-weight: 900; letter-spacing: .3px; color: #fff; text-shadow: 0 0 4px rgba(0,0,0,.7), 0 1px 8px rgba(0,0,0,.9); pointer-events: none; white-space: nowrap; }
    .marker-badge { backdrop-filter: blur(2px); background: rgba(2,10,25,var(--badge-alpha)); color: #fff; border: 1px solid rgba(255,255,255,0.15); padding: 2px 8px; border-radius: 8px; font-weight:800; display:inline-block; margin-left: 6px; }
    .legend { position:absolute; z-index:1000; bottom:14px; left:14px; background:#0f1730; border:1px solid #27335f; border-radius:12px; padding:10px 12px; box-shadow: 0 6px 20px rgba(0,0,0,.35); font-size:13px; color:#c9d6f3; }
    .legend .row{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .dot{ width:12px; height:12px; border-radius:50%; display:inline-block; border:1px solid rgba(255,255,255,.4); }
  </style>
  <script>
    // Si el CSS local no aplica, inyectar CDN
    document.addEventListener('DOMContentLoaded',()=>{
      const test=document.createElement('div'); test.className='leaflet-container'; test.style.position='absolute'; test.style.left='-9999px'; document.body.appendChild(test);
      setTimeout(()=>{
        const cs=getComputedStyle(test); const ok=cs.cursor==='grab'||cs.overflow==='hidden';
        if(!ok){ const cdn=document.createElement('link'); cdn.rel='stylesheet'; cdn.href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css'; document.head.appendChild(cdn); }
        test.remove();
      },300);
    });
  </script>
</head>
<body>
<div id="app">
  <header>
    <h1>üó∫Ô∏è Ibagu√© ‚Äî Comunas (13) y Corregimientos (17)</h1>
    <div class="pill"><label for="viewSel">Capa:</label>
      <select id="viewSel">
        <option value="comunas">Comunas (13)</option>
        <option value="corregimientos">Corregimientos (17)</option>
      </select>
    </div>
    <div class="pill"><label for="fontSel">Tama√±o letra:</label>
      <input id="fontSel" type="range" min="16" max="48" step="1" value="28" />
    </div>
    <div class="pill"><label for="alphaSel">Transparencia punto:</label>
      <input id="alphaSel" type="range" min="0.15" max="1" step="0.05" value="0.45" />
    </div>
    <div class="pill" style="flex:1 1 220px;">
      <label for="searchBox">Buscar‚Ä¶</label>
      <input id="searchBox" type="text" placeholder="Centro, Jord√°n, Juntas‚Ä¶" style="width: 100%;" />
    </div>
  </header>
  <div id="map"></div>
</div>

<!-- 2) Leaflet JS local ‚Üí CDNs y App -->
<script>
  function injectJS(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=()=>res(true); s.onerror=()=>rej(); document.head.appendChild(s); }); }
  injectJS('assets/leaflet/leaflet.js')
   <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ibagu√© v2 ‚Äî Comunas (13) y Corregimientos (17) con poblaci√≥n</title>
  <meta name="description" content="Mapa de Ibagu√© con comunas y corregimientos. Etiquetas grandes, puntos transparentes y badge de poblaci√≥n para ambas capas. Carga JSON externo con fallback inline con estimaciones referenciales." />

  <!-- Leaflet CSS local ‚Üí fallback CDN autom√°tico -->
  <link rel="stylesheet" href="assets/leaflet/leaflet.css" id="leafletCSSLocal" />
  <style>
    :root{ --label-font-size: 28px; --badge-alpha: .45 }
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background:#0b1020; color:#e8eef7; }
    #app { display:flex; flex-direction:column; height:100%; }
    header { padding: 10px 12px; background: #121a33; border-bottom: 1px solid #1f2a4d; display:flex; gap:12px; align-items:center; flex-wrap: wrap; position:sticky; top:0; z-index:10 }
    header h1 { font-size: 18px; margin:0; font-weight:700; letter-spacing:.2px; }
    header .pill { background: #0f1730; border:1px solid #27335f; padding:8px 10px; border-radius: 14px; display:flex; gap:8px; align-items:center; }
    label { font-size: 13px; color:#b6c3e4; }
    select, input[type="range"], input[type="text"]{ background:#0a1228; color:#e8eef7; border:1px solid #283562; border-radius:10px; padding:6px 8px; }
    #map { flex:1; width:100%; }
    .leaflet-container { background: #081022; }

    /* Etiquetas grandes y legibles */
    .marker-label { font-size: var(--label-font-size); font-weight: 900; letter-spacing: .3px; color: #fff; text-shadow: 0 0 4px rgba(0,0,0,.7), 0 1px 8px rgba(0,0,0,.9); pointer-events: none; white-space: nowrap; }
    .marker-badge { backdrop-filter: blur(2px); background: rgba(2,10,25,var(--badge-alpha)); color: #fff; border: 1px solid rgba(255,255,255,0.15); padding: 2px 8px; border-radius: 8px; font-weight:800; display:inline-block; margin-left: 6px; }
    .legend { position:absolute; z-index:1000; bottom:14px; left:14px; background:#0f1730; border:1px solid #27335f; border-radius:12px; padding:10px 12px; box-shadow: 0 6px 20px rgba(0,0,0,.35); font-size:13px; color:#c9d6f3; }
    .legend .row{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .dot{ width:12px; height:12px; border-radius:50%; display:inline-block; border:1px solid rgba(255,255,255,.4); }
  </style>
  <script>
    // Si el CSS local no aplica, inyectar CDN
    document.addEventListener('DOMContentLoaded',()=>{
      const test=document.createElement('div'); test.className='leaflet-container'; test.style.position='absolute'; test.style.left='-9999px'; document.body.appendChild(test);
      setTimeout(()=>{
        const cs=getComputedStyle(test); const ok=cs.cursor==='grab'||cs.overflow==='hidden';
        if(!ok){ const cdn=document.createElement('link'); cdn.rel='stylesheet'; cdn.href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css'; document.head.appendChild(cdn); }
        test.remove();
      },300);
    });
  </script>
</head>
<body>
<div id="app">
  <header>
    <h1>üó∫Ô∏è Ibagu√© ‚Äî Comunas (13) y Corregimientos (17)</h1>
    <div class="pill"><label for="viewSel">Capa:</label>
      <select id="viewSel">
        <option value="comunas">Comunas (13)</option>
        <option value="corregimientos">Corregimientos (17)</option>
      </select>
    </div>
    <div class="pill"><label for="fontSel">Tama√±o letra:</label>
      <input id="fontSel" type="range" min="16" max="48" step="1" value="28" />
    </div>
    <div class="pill"><label for="alphaSel">Transparencia punto:</label>
      <input id="alphaSel" type="range" min="0.15" max="1" step="0.05" value="0.45" />
    </div>
    <div class="pill" style="flex:1 1 220px;">
      <label for="searchBox">Buscar‚Ä¶</label>
      <input id="searchBox" type="text" placeholder="Centro, Jord√°n, Juntas‚Ä¶" style="width: 100%;" />
    </div>
  </header>
  <div id="map"></div>
</div>

<!-- Leaflet JS local ‚Üí CDNs y App -->
<script>
  function injectJS(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=()=>res(true); s.onerror=()=>rej(); document.head.appendChild(s); }); }
  injectJS('assets/leaflet/leaflet.js')
    .catch(()=>injectJS('https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'))
    .catch(()=>injectJS('https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js'))
    .then(initApp)
    .catch(()=>{ document.getElementById('map').innerHTML='<div style="padding:16px">No se pudo cargar Leaflet.</div>'; });

  // Fallback inline con estimaciones referenciales para corregimientos (2019)
  // Nota: cuando exista /data/datos_ibague.json con "pob" oficiales, el sistema usar√° esos y NO estos estimados.
  const FALLBACK_INLINE = {
    comunas: [
      { id:1,  nombre:'Centro',               lat:4.44341,  lng:-75.24116, pob:31009 },
      { id:2,  nombre:'Calambeo',             lat:4.45072,  lng:-75.24134, pob:41219 },
      { id:3,  nombre:'San Sim√≥n',            lat:4.44513,  lng:-75.22398, pob:24603 },
      { id:4,  nombre:'Piedrapintada',        lat:4.44132,  lng:-75.21016, pob:44077 },
      { id:5,  nombre:'Jord√°n',               lat:4.43874,  lng:-75.19411, pob:30549 },
      { id:6,  nombre:'Vergel',               lat:4.44914,  lng:-75.19169, pob:50477 },
      { id:7,  nombre:'Salado',               lat:4.44977,  lng:-75.14573, pob:44219 },
      { id:8,  nombre:'Sim√≥n Bol√≠var',        lat:4.43495,  lng:-75.17689, pob:77421 },
      { id:9,  nombre:'Picale√±a - Mirolindo', lat:4.42996,  lng:-75.19297, pob:64235 },
      { id:10, nombre:'Estadio',              lat:4.42950,  lng:-75.21830, pob:45149 },
      { id:11, nombre:'Ferias',               lat:4.42776,  lng:-75.22658, pob:31383 },
      { id:12, nombre:'Ricaurte',             lat:4.43098,  lng:-75.24165, pob:43130 },
      { id:13, nombre:'Boquer√≥n',             lat:4.40778,  lng:-75.26500, pob:16086 }
    ],
    corregimientos: [
      // pob_est: estimaci√≥n referencial 2019 (se muestra con etiqueta "ref.")
      { id:1,  nombre:'Dantas',               lat:4.34861,  lng:-75.39110, pob:null, pob_est:1600 },
      { id:2,  nombre:'Laureles',             lat:4.37026,  lng:-75.36415, pob:null, pob_est:1800 },
      { id:3,  nombre:'Coello - Cocora',      lat:4.40053,  lng:-75.29048, pob:null, pob_est:1600 },
      { id:4,  nombre:'Gamboa',               lat:4.41106,  lng:-75.33662, pob:null, pob_est:1800 },
      { id:5,  nombre:'Tapias',               lat:4.45583,  lng:-75.35830, pob:null, pob_est:2300 },
      { id:6,  nombre:'Toche',                lat:4.53332,  lng:-75.41668, pob:null, pob_est:1200 },
      { id:7,  nombre:'Juntas',               lat:4.55526,  lng:-75.32215, pob:null, pob_est:2800 },
      { id:8,  nombre:'Villa Restrepo',       lat:4.52434,  lng:-75.31086, pob:null, pob_est:3480 },
      { id:9,  nombre:'Cay',                  lat:4.47358,  lng:-75.25473, pob:null, pob_est:1400 },
      { id:10, nombre:'Calambeo (rural)',     lat:4.46050,  lng:-75.25200, pob:null, pob_est:1500 },
      { id:11, nombre:'San Juan de la China', lat:4.53333,  lng:-75.20000, pob:null, pob_est:2000 },
      { id:12, nombre:'San Bernardo',         lat:4.49626,  lng:-75.07548, pob:null, pob_est:1900 },
      { id:13, nombre:'El Salado (rural)',    lat:4.43100,  lng:-75.12000, pob:null, pob_est:1700 },
      { id:14, nombre:'Buenos Aires',         lat:4.33035,  lng:-75.08216, pob:null, pob_est:1600 },
      { id:15, nombre:'Carmen de Bulira',     lat:4.30500,  lng:-75.40250, pob:null, pob_est:1400 },
      { id:16, nombre:'El Totumo',            lat:4.37805,  lng:-75.18305, pob:null, pob_est:1800 },
      { id:17, nombre:'La Florida (rural)',   lat:4.44150,  lng:-75.19500, pob:null, pob_est:1500 }
    ]
  };

  async function loadDatos(){
    // 1) Intento JSON externo oficial
    try{
      const r = await fetch('data/datos_ibague.json', { cache:'no-store' });
      if(r.ok){ const j = await r.json(); return { data:j, source:'externo' }; }
    }catch(e){}
    // 2) Fallback inline con estimaciones referenciales
    return { data:FALLBACK_INLINE, source:'inline' };
  }

  function fmt(n){ return (n||n===0) ? Number(n).toLocaleString('es-CO') : '‚Äî'; }

  async function initApp(){
    const params = new URLSearchParams(location.search);
    let view = params.get('view') || 'comunas';
    let font = parseInt(params.get('font')||28, 10);
    let alpha = Math.min(1, Math.max(0.15, parseFloat(params.get('alpha')||0.45)));

    document.getElementById('fontSel').value = font;
    document.getElementById('alphaSel').value = alpha;
    document.getElementById('viewSel').value = view;
    document.documentElement.style.setProperty('--label-font-size', font+'px');
    document.documentElement.style.setProperty('--badge-alpha', alpha);

    const { data } = await loadDatos();

    const map = L.map('map', { zoomControl: true, minZoom: 11, maxZoom: 18 });
    const CENTER = [4.4447, -75.2432];
    map.setView(CENTER, 12);

    // Tiles + fallbacks
    const base = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'¬© OpenStreetMap' }).addTo(map);
    const fb = ['https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png','https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png'];
    let idx = 0; base.on('tileerror', ()=>{ if(idx<fb.length){ try{ base.setUrl(fb[idx++]); }catch(e){} } });

    // helpers visuales
    function makeCircle(lat,lng,color){ return L.circleMarker([lat,lng],{ radius: 9, color:'rgba(255,255,255,.35)', weight:1, fillColor:color, fillOpacity:alpha }); }
    function addLabel(marker, html){ marker.bindTooltip(html,{ permanent:true, direction:'top', className:'marker-label', offset:[0,-6] }); }
    function comunaHTML(c){ const pob=c.pob?`<span class="marker-badge">Pobl: ${Number(c.pob).toLocaleString('es-CO')}</span>`:''; return `<span>${c.id}. ${c.nombre}</span> ${pob}`; }
    function corregHTML(c){ const n=(c.pob??c.pob_est); const ref=(c.pob==null && c.pob_est!=null); const tag=n?`<span class=\"marker-badge\">Pobl: ${fmt(n)}${ref?' (ref.)':''}</span>`:''; return `<span>${c.id}. ${c.nombre}</span> ${tag}`; }

    const colorComuna = '#ffd166';
    const colorCorreg = '#06d6a0';

    // capas
    const capCom = L.layerGroup();
    (data.comunas||[]).forEach(c=>{ if(typeof c.lat!=='number') return; const m=makeCircle(c.lat,c.lng,colorComuna).addTo(capCom); addLabel(m,comunaHTML(c)); m.bindPopup(`<b>Comuna ${c.id}: ${c.nombre}</b>${c.pob?`<br/>Poblaci√≥n ref.: ${Number(c.pob).toLocaleString('es-CO')}`:''}`); });

    const capCor = L.layerGroup();
    (data.corregimientos||[]).forEach(c=>{ if(typeof c.lat!=='number') return; const m=makeCircle(c.lat,c.lng,colorCorreg).addTo(capCor); addLabel(m,corregHTML(c)); const n=(c.pob??c.pob_est); const ref=(c.pob==null && c.pob_est!=null); m.bindPopup(`<b>Corregimiento ${c.id}: ${c.nombre}</b><br/>Poblaci√≥n: ${fmt(n)}${ref?' (referencial)':''}`); });

    function showLayer(which){ map.eachLayer(l=>{ if(l!==base) map.removeLayer(l); }); const g = which==='corregimientos'?capCor:capCom; g.addTo(map); try{ map.fitBounds(g.getBounds().pad(0.2)); }catch(e){ map.setView(CENTER, 12); } }
    showLayer(view);

    // eventos UI
    const viewSel=document.getElementById('viewSel');
    const fontSel=document.getElementById('fontSel');
    const alphaSel=document.getElementById('alphaSel');
    const searchBox=document.getElementById('searchBox');

    viewSel.addEventListener('change', e=>{ view=e.target.value; showLayer(view); const u=new URL(location); u.searchParams.set('view',view); history.replaceState({},'',u); });
    fontSel.addEventListener('input', e=>{ font=parseInt(e.target.value,10); document.documentElement.style.setProperty('--label-font-size', font+'px'); const u=new URL(location); u.searchParams.set('font',font); history.replaceState({},'',u); });
    alphaSel.addEventListener('input', e=>{ alpha=parseFloat(e.target.value); document.documentElement.style.setProperty('--badge-alpha', alpha); [capCom,capCor].forEach(g=>g.eachLayer(l=>l.setStyle&&l.setStyle({fillOpacity:alpha}))); const u=new URL(location); u.searchParams.set('alpha',alpha.toFixed(2)); history.replaceState({},'',u); });
    searchBox.addEventListener('keydown', e=>{ if(e.key!=='Enter') return; const q=e.target.value.trim().toLowerCase(); if(!q) return; const ds=view==='corregimientos'?(data.corregimientos||[]):(data.comunas||[]); const hit=ds.find(x=>(`${x.id}. ${x.nombre}`.toLowerCase()).includes(q)||x.nombre.toLowerCase().includes(q)); if(hit&&typeof hit.lat==='number'){ map.flyTo([hit.lat,hit.lng],14,{duration:.8}); }});

    // leyenda
    const legend = L.control({position:'bottomleft'}); legend.onAdd=()=>{ const d=L.DomUtil.create('div','legend'); d.innerHTML=`<div class="row"><span class="dot" style="background:${colorComuna}"></span> Comunas (13)</div><div class="row"><span class="dot" style="background:${colorCorreg}"></span> Corregimientos (17)</div><div class="row"><span class="dot" style="background:rgba(2,10,25,var(--badge-alpha)); width:18px; height:10px; border-radius:4px"></span> Fondo etiqueta (transparente)</div>`; return d; }; legend.addTo(map);
  }
</script>
</body>
</html>
