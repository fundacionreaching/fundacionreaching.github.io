<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ibagu√© ‚Äî Comunas & Corregimientos (Lite: vista simple/detallada)</title>
  <meta name="description" content="Mapa de Ibagu√© con 13 comunas y 17 corregimientos. Vista simple/detallada, conmutadores de etiquetas y poblaci√≥n, auto‚Äëdensidad por zoom, b√∫squeda y par√°metros por URL." />
  <link rel="stylesheet" href="assets/leaflet/leaflet.css" id="leafletCSSLocal"/>
  <style>
    :root{ --label-font-size: 24px; --badge-alpha: .40 }
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background:#0b1020; color:#e8eef7; }
    #app { display:flex; flex-direction:column; height:100%; }
    header { padding: 10px 12px; background: #121a33; border-bottom: 1px solid #1f2a4d; display:flex; gap:12px; align-items:center; flex-wrap: wrap; position:sticky; top:0; z-index:10 }
    header h1 { font-size: 18px; margin:0; font-weight:700; letter-spacing:.2px; }
    .pill { background: #0f1730; border:1px solid #27335f; padding:8px 10px; border-radius: 14px; display:flex; gap:8px; align-items:center; }
    label { font-size: 13px; color:#b6c3e4; }
    select, input[type="range"], input[type="text"], input[type="checkbox"]{ background:#0a1228; color:#e8eef7; border:1px solid #283562; border-radius:10px; padding:6px 8px; }
    #map { flex:1; width:100%; }
    .leaflet-container { background: #081022; }

    /* Etiquetas grandes y legibles */
    .marker-label { font-size: var(--label-font-size); font-weight: 900; letter-spacing: .3px; color: #fff; text-shadow: 0 0 4px rgba(0,0,0,.7), 0 1px 8px rgba(0,0,0,.9); white-space: nowrap; }
    .marker-badge { backdrop-filter: blur(2px); background: rgba(2,10,25,var(--badge-alpha)); color: #fff; border: 1px solid rgba(255,255,255,0.15); padding: 2px 8px; border-radius: 8px; font-weight:800; display:inline-block; margin-left: 6px; }

    /* Conmutadores globales */
    .labels-off .leaflet-tooltip { display:none !important; }
    .pop-off .marker-badge { display:none !important; }
    .compact :root, .compact .marker-label { font-size: calc(var(--label-font-size) * .78); font-weight:800 }

    .legend { position:absolute; z-index:1000; bottom:14px; left:14px; background:#0f1730; border:1px solid #27335f; border-radius:12px; padding:10px 12px; box-shadow: 0 6px 20px rgba(0,0,0,.35); font-size:13px; color:#c9d6f3; }
    .legend .row{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .dot{ width:12px; height:12px; border-radius:50%; display:inline-block; border:1px solid rgba(255,255,255,.4); }
    .sep{height:1px;background:#22305c;margin:0 6px}
    .btn{cursor:pointer; border:1px solid #27335f; padding:6px 10px; border-radius:10px; background:#0a1228; color:#e8eef7}
    .btn.active{background:#13223a}
  </style>
  <script>
    // Si el CSS local no aplica, agregar CDN
    document.addEventListener('DOMContentLoaded',()=>{
      const test=document.createElement('div'); test.className='leaflet-container'; test.style.position='absolute'; test.style.left='-9999px'; document.body.appendChild(test);
      setTimeout(()=>{ const cs=getComputedStyle(test); const ok=cs.cursor==='grab'||cs.overflow==='hidden'; if(!ok){ const cdn=document.createElement('link'); cdn.rel='stylesheet'; cdn.href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css'; document.head.appendChild(cdn);} test.remove(); },300);
    });
  </script>
</head>
<body>
<div id="app">
  <header>
    <h1>üó∫Ô∏è Ibagu√© ‚Äî Comunas (13) y Corregimientos (17)</h1>

    <div class="pill" style="gap:6px">
      <span>Vista:</span>
      <button class="btn" id="mSimple">Simple</button>
      <button class="btn" id="mDet">Detallada</button>
    </div>

    <div class="pill">
      <label for="viewSel">Capa:</label>
      <select id="viewSel">
        <option value="comunas" selected>Comunas (13)</option>
        <option value="corregimientos">Corregimientos (17)</option>
      </select>
    </div>

    <div class="pill"><label for="fontSel">Letra:</label>
      <input id="fontSel" type="range" min="16" max="40" step="1" value="24" />
    </div>

    <div class="pill" style="gap:10px">
      <label><input type="checkbox" id="cbLabels" checked> Etiquetas</label>
      <label><input type="checkbox" id="cbPop"> Poblaci√≥n</label>
      <label><input type="checkbox" id="cbAuto" checked> Auto‚Äëdensidad</label>
    </div>

    <div class="pill" style="flex:1 1 240px;">
      <label for="searchBox">Buscar‚Ä¶</label>
      <input id="searchBox" type="text" placeholder="Centro, Jord√°n, Juntas‚Ä¶" style="width: 100%;" />
    </div>
  </header>
  <div id="map"></div>
</div>

<script>
  // Carga Leaflet JS con fallback
  function injectJS(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=()=>res(true); s.onerror=()=>rej(); document.head.appendChild(s); }); }
  injectJS('assets/leaflet/leaflet.js')
    .catch(()=>injectJS('https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'))
    .catch(()=>injectJS('https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js'))
    .then(initApp)
    .catch(()=>{ document.getElementById('map').innerHTML='<div style="padding:16px">No se pudo cargar Leaflet.</div>'; });

  // Datos (mismo esquema que v2). Fallback inline; si existe /data/datos_ibague.json, se usa ese.
  async function loadDatos(){
    try{ const r=await fetch('data/datos_ibague.json',{cache:'no-store'}); if(r.ok){ return await r.json(); } }catch(e){}
    return {
      comunas: [
        { id:1,  nombre:'Centro',               lat:4.44341,  lng:-75.24116, pob:31009 },
        { id:2,  nombre:'Calambeo',             lat:4.45072,  lng:-75.24134, pob:41219 },
        { id:3,  nombre:'San Sim√≥n',            lat:4.44513,  lng:-75.22398, pob:24603 },
        { id:4,  nombre:'Piedrapintada',        lat:4.44132,  lng:-75.21016, pob:44077 },
        { id:5,  nombre:'Jord√°n',               lat:4.43874,  lng:-75.19411, pob:30549 },
        { id:6,  nombre:'Vergel',               lat:4.44914,  lng:-75.19169, pob:50477 },
        { id:7,  nombre:'Salado',               lat:4.44977,  lng:-75.14573, pob:44219 },
        { id:8,  nombre:'Sim√≥n Bol√≠var',        lat:4.43495,  lng:-75.17689, pob:77421 },
        { id:9,  nombre:'Picale√±a - Mirolindo', lat:4.42996,  lng:-75.19297, pob:64235 },
        { id:10, nombre:'Estadio',              lat:4.42950,  lng:-75.21830, pob:45149 },
        { id:11, nombre:'Ferias',               lat:4.42776,  lng:-75.22658, pob:31383 },
        { id:12, nombre:'Ricaurte',             lat:4.43098,  lng:-75.24165, pob:43130 },
        { id:13, nombre:'Boquer√≥n',             lat:4.40778,  lng:-75.26500, pob:16086 }
      ],
      corregimientos: [
        { id:1,  nombre:'Dantas',               lat:4.34861,  lng:-75.39110, pob:1600 },
        { id:2,  nombre:'Laureles',             lat:4.37026,  lng:-75.36415, pob:1800 },
        { id:3,  nombre:'Coello - Cocora',      lat:4.40053,  lng:-75.29048, pob:1600 },
        { id:4,  nombre:'Gamboa',               lat:4.41106,  lng:-75.33662, pob:1800 },
        { id:5,  nombre:'Tapias',               lat:4.45583,  lng:-75.35830, pob:2300 },
        { id:6,  nombre:'Toche',                lat:4.53332,  lng:-75.41668, pob:1200 },
        { id:7,  nombre:'Juntas',               lat:4.55526,  lng:-75.32215, pob:2800 },
        { id:8,  nombre:'Villa Restrepo',       lat:4.52434,  lng:-75.31086, pob:3480 },
        { id:9,  nombre:'Cay',                  lat:4.47358,  lng:-75.25473, pob:1400 },
        { id:10, nombre:'Calambeo (rural)',     lat:4.46050,  lng:-75.25200, pob:1500 },
        { id:11, nombre:'San Juan de la China', lat:4.53333,  lng:-75.20000, pob:2000 },
        { id:12, nombre:'San Bernardo',         lat:4.49626,  lng:-75.07548, pob:1900 },
        { id:13, nombre:'El Salado (rural)',    lat:4.43100,  lng:-75.12000, pob:1700 },
        { id:14, nombre:'Buenos Aires',         lat:4.33035,  lng:-75.08216, pob:1600 },
        { id:15, nombre:'Carmen de Bulira',     lat:4.30500,  lng:-75.40250, pob:1400 },
        { id:16, nombre:'El Totumo',            lat:4.37805,  lng:-75.18305, pob:1800 },
        { id:17, nombre:'La Florida (rural)',   lat:4.44150,  lng:-75.19500, pob:1500 }
      ]
    };
  }

  function fmt(n){ return (n||n===0)? Number(n).toLocaleString('es-CO') : '‚Äî'; }

  function initApp(){
    const qs = new URLSearchParams(location.search);
    let view   = qs.get('view')||'comunas';
    let font   = parseInt(qs.get('font')||24,10);
    let mode   = qs.get('mode')||'simple'; // simple|detallado
    let labels = (qs.get('labels')||'1')==='1';
    let pop    = (qs.get('pop')|| (mode==='detallado'?'1':'0'))==='1';
    let autod  = (qs.get('autod')||'1')==='1';

    const fontSel = document.getElementById('fontSel');
    const viewSel = document.getElementById('viewSel');
    const cbLabels= document.getElementById('cbLabels');
    const cbPop   = document.getElementById('cbPop');
    const cbAuto  = document.getElementById('cbAuto');
    const mSimple = document.getElementById('mSimple');
    const mDet    = document.getElementById('mDet');
    const searchBox = document.getElementById('searchBox');

    // UI inicial
    document.documentElement.style.setProperty('--label-font-size', font+'px');
    fontSel.value = font;
    viewSel.value = view;
    cbLabels.checked = labels;
    cbPop.checked    = pop;
    cbAuto.checked   = autod;
    (mode==='simple'?mSimple:mDet).classList.add('active');
    document.body.classList.toggle('labels-off', !labels);
    document.body.classList.toggle('pop-off', !pop);
    document.body.classList.toggle('compact', mode==='simple');

    const CENTER=[4.4447,-75.2432];
    const map=L.map('map',{zoomControl:true,minZoom:11,maxZoom:18});
    map.setView(CENTER,12);

    const base=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(map);
    const fb=['https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png','https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png'];
    let idx=0;base.on('tileerror',()=>{ if(idx<fb.length){ try{ base.setUrl(fb[idx++]); }catch(e){} } });

    // Cargar datos y construir capas
    loadDatos().then(data=>{
      const colorComuna='#ffd166', colorCorreg='#06d6a0';
      const capCom=L.layerGroup(), capCor=L.layerGroup();

      // almacenamos referencias para (des)agregar etiquetas seg√∫n zoom
      const store={ com:[], cor:[] };

      function makeCircle(lat,lng,color){ return L.circleMarker([lat,lng],{ radius: 9, color:'rgba(255,255,255,.35)', weight:1, fillColor:color, fillOpacity:.45 }); }
      function labelHTML(p){ const badge = `<span class="marker-badge">Pobl: ${fmt(p.pob)}</span>`; return `<span>${p.id}. ${p.nombre}</span> ${badge}`; }

      (data.comunas||[]).forEach((c,i)=>{
        if(typeof c.lat!=='number') return;
        const m=makeCircle(c.lat,c.lng,colorComuna).addTo(capCom);
        store.com.push({m, data:c, idx:i, layer:capCom});
      });
      (data.corregimientos||[]).forEach((c,i)=>{
        if(typeof c.lat!=='number') return;
        const m=makeCircle(c.lat,c.lng,colorCorreg).addTo(capCor);
        store.cor.push({m, data:c, idx:i, layer:capCor});
      });

      function addLabel(entry){ if(entry.tooltipAdded) return; entry.m.bindTooltip(labelHTML(entry.data),{permanent:true,direction:'top',className:'marker-label',offset:[0,-6]}); entry.tooltipAdded=true; }
      function removeLabel(entry){ if(!entry.tooltipAdded) return; entry.m.unbindTooltip(); entry.tooltipAdded=false; }

      function applyDensity(which){
        const zoom=map.getZoom();
        const arr = (which==='corregimientos'?store.cor:store.com);
        // Reglas simples: <12 ninguna etiqueta; 12‚Äì13 mitad; >=14 todas
        let show=0; if(zoom>=14) show=2; else if(zoom>=12) show=1; else show=0;
        arr.forEach((e,i)=>{
          if(!autod){ // si auto-densidad OFF, solo respetar labels ON/OFF global
            if(labels) addLabel(e); else removeLabel(e); return;
          }
          if(!labels){ removeLabel(e); return; }
          if(show===0){ removeLabel(e); }
          else if(show===1){ (i%2===0)? addLabel(e): removeLabel(e); }
          else { addLabel(e); }
        });
      }

      function showLayer(which){
        map.eachLayer(l=>{ if(l!==base) map.removeLayer(l); });
        const g = which==='corregimientos'?capCor:capCom; g.addTo(map);
        try{ map.fitBounds(g.getBounds().pad(0.18)); }catch(e){ map.setView(CENTER,12); }
        applyDensity(which);
      }

      // Inicial
      showLayer(view);

      // === UI eventos ===
      viewSel.addEventListener('change', e=>{ view=e.target.value; sync('view',view); showLayer(view); });
      fontSel.addEventListener('input', e=>{ font=parseInt(e.target.value,10); document.documentElement.style.setProperty('--label-font-size', font+'px'); sync('font',font); });

      cbLabels.addEventListener('change', e=>{ labels=e.target.checked; document.body.classList.toggle('labels-off', !labels); applyDensity(view); sync('labels', labels?1:0); });
      cbPop.addEventListener('change', e=>{ pop=e.target.checked; document.body.classList.toggle('pop-off', !pop); sync('pop', pop?1:0); });
      cbAuto.addEventListener('change', e=>{ autod=e.target.checked; applyDensity(view); sync('autod', autod?1:0); });

      mSimple.addEventListener('click', ()=>{ mode='simple'; mSimple.classList.add('active'); mDet.classList.remove('active'); document.body.classList.add('compact'); if(pop){ pop=false; cbPop.checked=false; document.body.classList.add('pop-off'); } sync('mode','simple'); applyDensity(view); });
      mDet.addEventListener('click', ()=>{ mode='detallado'; mDet.classList.add('active'); mSimple.classList.remove('active'); document.body.classList.remove('compact'); if(!pop){ pop=true; cbPop.checked=true; document.body.classList.remove('pop-off'); } sync('mode','detallado'); applyDensity(view); });

      searchBox.addEventListener('keydown', e=>{ if(e.key!=='Enter') return; const q=e.target.value.trim().toLowerCase(); if(!q) return; const ds=view==='corregimientos'?store.cor:store.com; const hit=ds.find(x=> (`${x.data.id}. ${x.data.nombre}`.toLowerCase()).includes(q) || x.data.nombre.toLowerCase().includes(q) ); if(hit){ map.flyTo(hit.m.getLatLng(), 14, {duration:.8}); addLabel(hit); } });

      map.on('zoomend moveend', ()=> applyDensity(view));

      // util
      function sync(k,v){ const u=new URL(location); u.searchParams.set(k,String(v)); history.replaceState({},'',u); }
    });
  }
</script>
</body>
</html>
