<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plataforma Proyectos Censo – Tolima | Fundación Reaching</title>
  <meta name="description" content="Plataforma de censo ciudadano y ministerial para Tolima e Ibagué. Registro, estadísticas en vivo, mapa, exportación y conexión a hojas de cálculo." />
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('censoApp', () => ({
      // Tema
      prefersDark: window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches,
      toggleTheme(){ this.prefersDark = !this.prefersDark; },

      // Estado UI / KPIs
      nivel: 'municipios',
      buscar: '',
      kpi: { municipios: 0, comunas: 0, correg: 0, poblacion: 0 },

      // Rutas por defecto (GitHub Pages)
      geojsonComunasUrl:  localStorage.getItem('geojson_comunas')  || 'https://fundacionreaching.github.io/ibague_comunas.geojson',
      geojsonCorregUrl:   localStorage.getItem('geojson_correg')   || 'https://fundacionreaching.github.io/ibague_corregimientos.geojson',
      geojsonVeredasUrl:  localStorage.getItem('geojson_veredas')  || 'https://fundacionreaching.github.io/ibague_veredas.geojson',

      // Población / Años / Métrica
      aniosPoblacion: Array.from({length: (2042-2018)+1}, (_,i)=>2018+i),
      anioPoblacion: new Date().getFullYear(),
      metrica: 'total',

      // Datos / Tabla
      poblacionTolima: {},
      features: { municipios: [], comunas: [], correg: [], veredas: [] },
      filas: [],
      get filasFiltradas(){ const q=this.buscar.toLowerCase(); return (this.filas||[]).filter(f=> (f.nombre||'').toLowerCase().includes(q)); },

      // Mapa
      map:null, capaTolima:null, capaComunas:null, capaCorreg:null, capaVeredas:null, leyendaCtrl:null,

      init(){ this.$nextTick(()=>{ lucide.createIcons(); this._initMap(); }); },

      // ===== MAPA =====
      _initMap(){
        this.map = L.map('mapaCanvas', { tap: true }).setView([4.4389, -75.2322], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(this.map);
        this.capaTolima  = L.geoJSON(null, { onEachFeature: this._onEachTolima.bind(this), style: this._styleTolima.bind(this) }).addTo(this.map);
        this.capaComunas = L.geoJSON(null, { onEachFeature: this._onEachIbague.bind(this), style: this._styleIbague.bind(this) });
        this.capaCorreg  = L.geoJSON(null, { onEachFeature: this._onEachIbague.bind(this), style: this._styleIbague.bind(this) });
        this.capaVeredas = L.geoJSON(null, { onEachFeature: this._onEachIbague.bind(this), style: this._styleIbague.bind(this) });
        L.control.layers(null, {
          'Tolima – Municipios': this.capaTolima,
          'Ibagué – Comunas': this.capaComunas,
          'Ibagué – Corregimientos': this.capaCorreg,
          'Ibagué – Veredas': this.capaVeredas
        }, { collapsed: true }).addTo(this.map);
        this._crearLeyenda();
      },

      async cargarTolima(){
        const localUrl = 'https://fundacionreaching.github.io/tolima_municipios.geojson';
        let gj=null; try{ const r=await fetch(localUrl,{cache:'no-store'}); if(r.ok) gj=await r.json(); }catch(_){ }
        if(!gj){ const url='https://geoportal.dane.gov.co/mparcgis/rest/services/Divipola/Cache_DivipolaEntidadesTerritorialesCP/MapServer/9/query?where=DPTO_CCDGO%3D%2773%27&outFields=*%2CMPIO_CCDGO%2CMPIO_CNMBR&f=geojson'; gj = await fetch(url).then(r=>r.json()); }
        this.capaTolima.clearLayers(); if(gj&&gj.features){ this.capaTolima.addData(gj); this.map.fitBounds(this.capaTolima.getBounds()); this._capturar('municipios', this.capaTolima, ['MPIO_CNMBR','NOMBRE'], ['MPIO_CCDGO','CODIGO']); this.reestilizarCapas(); this._actualizarKPIs(); } else alert('No se pudo cargar Tolima.');
      },

      async cargarIbague(){
        try{
          if(this.geojsonComunasUrl){ localStorage.setItem('geojson_comunas', this.geojsonComunasUrl); const gj1 = await fetch(this.geojsonComunasUrl,{cache:'no-store'}).then(r=>r.json()); this.capaComunas.clearLayers(); if(gj1&&gj1.features){ this.capaComunas.addData(gj1); this._capturar('comunas', this.capaComunas, ['NOMBRE','name'], ['CODIGO','id']); } }
          if(this.geojsonCorregUrl){ localStorage.setItem('geojson_correg', this.geojsonCorregUrl); const gj2 = await fetch(this.geojsonCorregUrl,{cache:'no-store'}).then(r=>r.json()); this.capaCorreg.clearLayers(); if(gj2&&gj2.features){ this.capaCorreg.addData(gj2); this._capturar('correg', this.capaCorreg, ['NOMBRE','name'], ['CODIGO','id']); } }
          if(this.geojsonVeredasUrl){ localStorage.setItem('geojson_veredas', this.geojsonVeredasUrl); const gj3 = await fetch(this.geojsonVeredasUrl,{cache:'no-store'}).then(r=>r.json()); this.capaVeredas.clearLayers(); if(gj3&&gj3.features){ this.capaVeredas.addData(gj3); this._capturar('veredas', this.capaVeredas, ['NOMBRE','name'], ['CODIGO','id']); } }
          const b = this.capaComunas.getLayers().length? this.capaComunas.getBounds() : (this.capaCorreg.getLayers().length? this.capaCorreg.getBounds() : (this.capaVeredas.getLayers().length? this.capaVeredas.getBounds(): null));
          if(b) this.map.fitBounds(b);
          this.reestilizarCapas(); this._actualizarKPIs();
        }catch(e){ console.error(e); alert('No se pudo cargar comunas/corregimientos/veredas.'); }
      },

      // Estilos y popups
      _styleTolima(f){ const key=this._keyMunicipio(f); const n=this._poblacionByKey(key); const a=this._areaFromFeature(f); const v=(this.metrica==='densidad'&&n&&a)?(n/a):n; return { color:'#1f2937', weight:1, fillColor:this._colorChoro(v), fillOpacity:.7 }; },
      _styleIbague(f){ const key=this._keyGenerico(f); const n=this._poblacionByKey(key)||this._poblacionByKey((f.properties.NOMBRE||f.properties.name||'').toUpperCase()); const a=this._areaFromFeature(f); const v=(this.metrica==='densidad'&&n&&a)?(n/a):n; return { color:'#1f2937', weight:1, fillColor:this._colorChoro(v), fillOpacity:.7 }; },
      _onEachTolima(f, layer){ layer.on('click', ()=>{ const nom=(f.properties.MPIO_CNMBR||f.properties.NOMBRE||'').toUpperCase(); const key=this._keyMunicipio(f); const n=this._poblacionByKey(key); const a=this._areaFromFeature(f); const d=(n&&a)?(n/a).toFixed(1):'—'; layer.bindPopup(`<strong>${nom}</strong><br>Población ${this.anioPoblacion}: ${this._fmt(n)}<br>Área: ${a?a.toFixed(2):'—'} km²<br>Densidad: ${d}`).openPopup(); }); },
      _onEachIbague(f, layer){ layer.on('click', ()=>{ const nom=(f.properties.NOMBRE||f.properties.name||'').toUpperCase(); const key=this._keyGenerico(f)||nom; const n=this._poblacionByKey(key)||this._poblacionByKey(nom); const a=this._areaFromFeature(f); const d=(n&&a)?(n/a).toFixed(1):'—'; layer.bindPopup(`<strong>${nom}</strong><br>Población ${this.anioPoblacion}: ${this._fmt(n)}<br>Área: ${a?a.toFixed(2):'—'} km²<br>Densidad: ${d}`).openPopup(); }); },

      reestilizarCapas(){ if(this.capaTolima) this.capaTolima.setStyle(this._styleTolima.bind(this)); if(this.capaComunas) this.capaComunas.setStyle(this._styleIbague.bind(this)); if(this.capaCorreg) this.capaCorreg.setStyle(this._styleIbague.bind(this)); if(this.capaVeredas) this.capaVeredas.setStyle(this._styleIbague.bind(this)); this._actualizarLeyenda(); },
      _colorChoro(v){ if(v==null||isNaN(v)) return '#e5e7eb'; return v>500000?'#1d4ed8': v>200000?'#3b82f6': v>80000?'#60a5fa': v>30000?'#93c5fd': v>10000?'#bfdbfe':'#dbeafe'; },
      _crearLeyenda(){ const ctrl=L.control({position:'bottomright'}); ctrl.onAdd=()=>{ const div=L.DomUtil.create('div','rounded-2xl text-xs p-3 bg-white/80 dark:bg-gray-900/80 shadow border border-gray-200 dark:border-gray-800'); div.innerHTML=`<strong>Leyenda</strong><div id="legend-grades" class="mt-2 space-y-1"></div>`; return div; }; ctrl.addTo(this.map); this.leyendaCtrl=ctrl; this._actualizarLeyenda(); },
      _actualizarLeyenda(){ const el=document.getElementById('legend-grades'); if(!el) return; const rangos=[0,10000,30000,80000,200000,500000]; el.innerHTML=rangos.map((r,i)=>{ const s=this._colorChoro(r+1); const label=i<rangos.length-1?`${this._fmt(r)}–${this._fmt(rangos[i+1])}`:`>${this._fmt(r)}`; return `<div class='flex items-center gap-2'><span style='background:${s}' class='inline-block w-4 h-3 rounded'></span><span>${label}</span></div>`; }).join(''); },

      // ==== CSV / Tabla ====
      exportarCSV(){ const head=['nombre','codigo','poblacion','area_km2','densidad']; const rows=[head].concat((this.filas||[]).map(f=>[f.nombre,f.codigo||'',f.poblacion||'',f.area||'',(f.poblacion&&f.area)?(f.poblacion/f.area).toFixed(1):''])); const csv=rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('
'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); a.download=`tabla_${this.nivel}_${this.anioPoblacion}.csv`; a.click(); }"`).join(',')).join('
'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); a.download=`tabla_${this.nivel}_${this.anioPoblacion}.csv`; a.click(); },
      descargarPlantilla(){ const csv='divipola,codigo,nombre,poblacion,anio,area_km2
'; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='plantilla_poblacion.csv'; a.click(); })); a.download='plantilla_poblacion.csv'; a.click(); },
      async cargarCSV(e){ const f=e.target.files[0]; if(!f) return; const t=await f.text(); this._ingestarCSV(t); this._actualizarKPIs(); this.reestilizarCapas(); },
      async cargarPoblacionGit(){ const urls=['https://fundacionreaching.github.io/dane_tolima_poblacion.csv','https://fundacionreaching.github.io/ibague_comunas_poblacion.csv','https://fundacionreaching.github.io/ibague_corregimientos_poblacion.csv','https://fundacionreaching.github.io/ibague_veredas_poblacion.csv']; let ok=0; for(const u of urls){ try{ const r=await fetch(u,{cache:'no-store'}); if(r.ok){ const txt=await r.text(); this._ingestarCSV(txt); ok++; } }catch(_){} } this._toast(ok?`Población cargada (${ok})`:'No se pudo cargar población'); this._actualizarKPIs(); this.reestilizarCapas(); },
      _ingestarCSV(text){ const rows=text.trim().split(/
?
/).map(r=>r.split(',')); const head=rows.shift().map(s=>s.trim().toUpperCase()); const iKey=head.indexOf('DIVIPOLA')>-1?head.indexOf('DIVIPOLA'):(head.indexOf('CODIGO')>-1?head.indexOf('CODIGO'):(head.indexOf('MUNICIPIO')>-1?head.indexOf('MUNICIPIO'):head.indexOf('NOMBRE'))); const iAnio=head.indexOf('ANIO')>-1?head.indexOf('ANIO'):head.indexOf('AÑO'); const iPob=head.indexOf('POBLACION')>-1?head.indexOf('POBLACION'):head.indexOf('POBLACIÓN'); const iArea=head.indexOf('AREA_KM2'); if(iKey<0||iPob<0) return; rows.forEach(r=>{ const key=(r[iKey]||'').toUpperCase(); this.poblacionTolima[key]=this.poblacionTolima[key]||{}; const an=iAnio>=0?Number(r[iAnio]):'total'; this.poblacionTolima[key][an]=Number(r[iPob]); if(iArea>=0) this.poblacionTolima[key].area_km2=Number(r[iArea]); }); }; const an=iAnio>=0?Number(r[iAnio]):'total'; this.poblacionTolima[key][an]=Number(r[iPob]); if(iArea>=0) this.poblacionTolima[key].area_km2=Number(r[iArea]); }); },

      // ==== Helpers ====
      _fmt(n){ if(n==null||isNaN(n)) return '—'; return Number(n).toLocaleString('es-CO'); }, fmt(n){ return this._fmt(n); },
      _keyMunicipio(f){ return ((f.properties.MPIO_CCDGO||f.properties.CODIGO||f.properties.MPIO_CNMBR||f.properties.NOMBRE)||'').toString().toUpperCase(); },
      _keyGenerico(f){  return ((f.properties.CODIGO||f.properties.id||f.properties.NOMBRE||f.properties.name)||'').toString().toUpperCase(); },
      _nombreFrom(f, arr){ for(const k of arr){ if(f.properties[k]) return String(f.properties[k]); } return '—'; },
      _areaFromFeature(f){ if(f.properties.AREA_KM2) return Number(f.properties.AREA_KM2); if(f.properties.SHAPE_Area) return Number(f.properties.SHAPE_Area)/1e6; return null; },
      _poblacionByKey(key){ const reg=this.poblacionTolima[key]||this.poblacionTolima[(key||'').toUpperCase()]||null; return reg? Number(reg[this.anioPoblacion]||reg.total||0): 0; },
      _capturar(tipo,capa,camNom=['NOMBRE'],camCod=['CODIGO']){ const out=[]; capa.eachLayer(l=>{ const f=l.feature; const nombre=this._nombreFrom(f,camNom); const codigo=(camCod.map(k=>f.properties[k]).find(Boolean))||''; const key=(codigo||nombre).toString().toUpperCase(); const pob=this._poblacionByKey(key); const area=this._areaFromFeature(f); out.push({ key, nombre, codigo, poblacion:pob||0, area: area||null }); }); this.features[tipo]=out; this.filas=this.features[this.nivel]||[]; },
      _actualizarKPIs(){ this.kpi={ municipios:(this.features.municipios||[]).length, comunas:(this.features.comunas||[]).length, correg:(this.features.correg||[]).length, poblacion:Object.values(this.poblacionTolima).reduce((s,o)=> s+Number(o[this.anioPoblacion]||o.total||0),0)}; this.filas=this.features[this.nivel]||[]; },

      _toast(msg){ const el=document.createElement('div'); el.textContent=msg; el.className='fixed bottom-5 left-1/2 -translate-x-1/2 px-4 py-2 bg-gray-900 text-white rounded-2xl shadow z-50'; document.body.appendChild(el); setTimeout(()=>el.remove(), 2000); }
    }))
  })
</script>
</body>
</html>




