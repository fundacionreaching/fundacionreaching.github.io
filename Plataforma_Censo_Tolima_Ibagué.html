<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plataforma Proyectos Censo – Tolimaima | Fundación Reaching</title>
  <meta name="description" content="Plataforma de censo ciudadano y ministerial para Tolima e Ibagué. Registro, estadísticas en vivo, mapa, exportación y conexión a hojas de cálculo." />
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: { primary: {
            50: '#eff6ff', 100:'#dbeafe', 200:'#bfdbfe', 300:'#93c5fd', 400:'#60a5fa', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 800:'#1e40af', 900:'#1e3a8a'
          }}
        }
      },
      darkMode: 'class'
    }
  </script>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Leaflet (mapas) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Open Graph -->
  <meta property="og:title" content="Plataforma Proyectos Censo – Tolima" />
  <meta property="og:description" content="Registra tu hogar, ministerio y necesidades. Juntos construimos soluciones con fe y datos." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://fundacionreaching.github.io/assets/og-censo-tolima.png" />
  <style>
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,.7); }
    .dark .glass { background: rgba(17,24,39,.6); }
  </style>
</head>
<body x-data="censoApp" x-init="init()" :class="{dark: prefersDark}">
  <!-- Barra superior -->
  <header class="sticky top-0 z-40 bg-white/80 dark:bg-gray-900/80 backdrop-blur border-b border-gray-200 dark:border-gray-800">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <img src="https://fundacionreaching.github.io/assets/logo-reaching.png" alt="Fundación Reaching" class="h-10 w-10 rounded-xl shadow" onerror="this.style.display='none'"/>
      <div class="flex-1">
        <h1 class="text-lg font-extrabold tracking-tight text-gray-900 dark:text-white">Plataforma Proyectos Censo – Tolima</h1>
        <p class="text-xs text-gray-600 dark:text-gray-300">Fundación Reaching • Encuentro con Dios • Oración Mundial RTV</p>
      </div>
      <button @click="toggleTheme" class="inline-flex items-center gap-2 px-3 py-2 rounded-2xl bg-gray-900 text-white dark:bg-gray-100 dark:text-gray-900 shadow">
        <i data-lucide="moon" class="w-4 h-4" x-show="!prefersDark"></i>
        <i data-lucide="sun" class="w-4 h-4" x-show="prefersDark"></i>
        <span class="text-sm">Tema</span>
      </button>
      <a href="#formulario" class="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-2xl bg-primary-600 text-white shadow">
        <i data-lucide="clipboard-edit" class="w-4 h-4"></i>
        <span class="text-sm font-semibold">Nuevo registro</span>
      </a>
    </div>
  </header>

  <!-- Hero -->
  <section class="relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-br from-primary-600 via-primary-500 to-sky-400 opacity-20 dark:opacity-30"></div>
    <div class="max-w-6xl mx-auto px-4 py-8 md:py-12 grid md:grid-cols-2 gap-8 items-center">
      <div class="space-y-4">
        <h2 class="text-3xl md:text-4xl font-black text-gray-900 dark:text-white leading-tight">Censo + Mapas + Indicadores: <span class="text-primary-700 dark:text-primary-300">Tolima de vereda a departamento</span></h2>
        <p class="text-gray-700 dark:text-gray-300">Plataforma optimizada para <strong>proyectos</strong>: población DANE, desagregación por <em>municipios, comunas, corregimientos y veredas</em>, tablas exportables y mapas responsivos para celular y computador.</p>
        <div class="flex flex-wrap gap-3">
          <a href="#mapa" class="px-4 py-2 rounded-2xl bg-primary-600 text-white font-semibold shadow hover:bg-primary-700">Ir al mapa</a>
          <a href="#tabla" class="px-4 py-2 rounded-2xl border border-gray-300 dark:border-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-800">Ver tabla</a>
          <button @click="imprimir()" class="px-4 py-2 rounded-2xl bg-emerald-600 text-white font-semibold shadow hover:bg-emerald-700">Exportar PDF</button>
        </div>
      </div>
      <div class="glass rounded-3xl p-5 shadow-xl border border-white/40 dark:border-gray-700">
        <div class="grid grid-cols-2 gap-3 text-center">
          <div class="p-4 rounded-2xl bg-white/70 dark:bg-gray-800/60">
            <p class="text-xs uppercase tracking-wider text-gray-500">Total municipios</p>
            <p class="text-3xl font-black text-primary-700 dark:text-primary-300" x-text="kpi.municipios"></p>
          </div>
          <div class="p-4 rounded-2xl bg-white/70 dark:bg-gray-800/60">
            <p class="text-xs uppercase tracking-wider text-gray-500">Comunas (Ibagué)</p>
            <p class="text-3xl font-black text-primary-700 dark:text-primary-300" x-text="kpi.comunas"></p>
          </div>
          <div class="p-4 rounded-2xl bg-white/70 dark:bg-gray-800/60">
            <p class="text-xs uppercase tracking-wider text-gray-500">Corregimientos</p>
            <p class="text-3xl font-black text-primary-700 dark:text-primary-300" x-text="kpi.correg"></p>
          </div>
          <div class="p-4 rounded-2xl bg-white/70 dark:bg-gray-800/60">
            <p class="text-xs uppercase tracking-wider text-gray-500">Población cargada</p>
            <p class="text-3xl font-black text-primary-700 dark:text-primary-300" x-text="kpi.poblacion.toLocaleString('es-CO')"></p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Resumen Proyecto -->
  <section id="resumen" class="max-w-6xl mx-auto px-4 py-8">
    <div class="bg-white dark:bg-gray-900 shadow-xl rounded-3xl border border-gray-200 dark:border-gray-800 overflow-hidden">
    <div class="px-5 py-4 border-b border-gray-200 dark:border-gray-800 flex items-center gap-2"><i data-lucide="table" class="w-5 h-5 text-primary-600"></i><h3 class="text-lg font-bold">Tabla territorial</h3></div>
        <div id="tabla" class="p-4 overflow-x-auto">
          <div class="flex flex-wrap items-center gap-3 mb-3">
            <input type="search" placeholder="Buscar territorio..." class="w-full md:w-64 rounded-2xl border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800" x-model="buscar" />
            <span class="text-xs text-gray-500">Filas: <strong x-text="filas.length"></strong></span>
          </div>
          <table class="min-w-full text-sm">
            <thead class="text-left text-gray-500">
              <tr>
                <th class="py-2 pr-4">Nombre</th>
                <th class="py-2 pr-4">Código</th>
                <th class="py-2 pr-4">Población</th>
                <th class="py-2 pr-4">Área km²</th>
                <th class="py-2 pr-4">Densidad</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="f in filasFiltradas" :key="f.key">
                <tr class="border-t border-gray-100 dark:border-gray-800">
                  <td class="py-2 pr-4" x-text="f.nombre"></td>
                  <td class="py-2 pr-4" x-text="f.codigo || '—'"></td>
                  <td class="py-2 pr-4" x-text="fmt(f.poblacion)"></td>
                  <td class="py-2 pr-4" x-text="f.area? f.area.toFixed(2): '—'"></td>
                  <td class="py-2 pr-4" x-text="(f.poblacion && f.area)? (f.poblacion/f.area).toFixed(1): '—'"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>de Tolima desde DANE.'); }
        },

        async cargarIbague(){
          try{
            if(this.geojsonComunasUrl){ localStorage.setItem('geojson_comunas', this.geojsonComunasUrl); const gj1 = await fetch(this.geojsonComunasUrl).then(r=>r.json()); this.capaComunas.clearLayers(); this.capaComunas.addData(gj1); }
            if(this.geojsonCorregUrl){ localStorage.setItem('geojson_correg', this.geojsonCorregUrl); const gj2 = await fetch(this.geojsonCorregUrl).then(r=>r.json()); this.capaCorreg.clearLayers(); this.capaCorreg.addData(gj2); }
            if(this.capaComunas.getLayers().length) this.map.fitBounds(this.capaComunas.getBounds()); else if(this.capaCorreg.getLayers().length) this.map.fitBounds(this.capaCorreg.getBounds());
            this.reestilizarCapas();
          }catch(e){ console.error(e); alert('No se pudo cargar comunas/corregimientos. Verifique URLs GeoJSON.'); }
        },

        _styleTolima(f){ const n = this._poblacionMunicipio(f); const d = this._densidadMunicipio(f, n); const v = this.metrica==='densidad' ? d : n; return { color:'#1f2937', weight:1, fillColor: this._colorChoro(v), fillOpacity: .7 }; },
        _styleIbague(f){ const n = this._poblacionSubzona(f); const v = n || 0; return { color:'#1f2937', weight:1, fillColor: this._colorChoro(v), fillOpacity: .7 }; },

        _onEachTolima(f, layer){ layer.on('click', ()=>{ const n = this._poblacionMunicipio(f); const d = this._densidadMunicipio(f, n); const nom = (f.properties.MPIO_CNMBR || f.properties.NOMBRE || '').toUpperCase(); layer.bindPopup(`<strong>${nom}</strong><br>Población ${this.anioPoblacion}: ${this._fmt(n)}<br>Densidad: ${isFinite(d)?d.toFixed(1):'—'} hab/km²`).openPopup(); }); },
        _onEachIbague(f, layer){ layer.on('click', ()=>{ const nom = (f.properties.NOMBRE || f.properties.name || '').toUpperCase(); const n = this._poblacionSubzona(f); layer.bindPopup(`<strong>${nom}</strong><br>Población ${this.anioPoblacion}: ${this._fmt(n)}`).openPopup(); }); },

        _poblacionMunicipio(f){ const nom = (f.properties.MPIO_CNMBR || f.properties.NOMBRE || '').toUpperCase(); const reg = this.poblacionTolima[nom] || {}; return Number(reg[this.anioPoblacion]) || Number(reg.total) || null; },
        _densidadMunicipio(f, n){ const area = (this.poblacionTolima[(f.properties.MPIO_CNMBR||'').toUpperCase()]||{}).area_km2 || (f.properties.SHAPE_Area? f.properties.SHAPE_Area/1e6 : null); return n && area ? n/area : NaN; },
        _poblacionSubzona(f){ const nom = (f.properties.NOMBRE || f.properties.name || '').toUpperCase(); const reg = this.poblacionTolima[nom] || {}; return Number(reg[this.anioPoblacion]) || Number(reg.total) || null; },

        reestilizarCapas(){ if(this.capaTolima) this.capaTolima.setStyle(this._styleTolima.bind(this)); if(this.capaComunas) this.capaComunas.setStyle(this._styleIbague.bind(this)); if(this.capaCorreg) this.capaCorreg.setStyle(this._styleIbague.bind(this)); this._actualizarLeyenda(); },

        _colorChoro(v){ if(v==null || isNaN(v)) return '#e5e7eb'; return v>500000?'#1d4ed8': v>200000?'#3b82f6': v>80000?'#60a5fa': v>30000?'#93c5fd': v>10000?'#bfdbfe':'#dbeafe'; },

        _crearLeyenda(){ const ctrl = L.control({position:'bottomright'}); ctrl.onAdd = ()=>{ const div=L.DomUtil.create('div','rounded-2xl text-xs p-3 bg-white/80 <h3 class="text-lg font-bold mb-2">Capas geográficas (Tolima / Ibagué)</h3>
        <p class="text-sm text-gray-600 dark:text-gray-300">Active mapas con población para proyectos y radicaciones oficiales.</p>
        <div class="mt-3 space-y-3">
          <button @click="cargarTolima()" class="w-full px-4 py-2 rounded-2xl bg-primary-600 text-white font-semibold">Tolima: Municipios (GeoJSON local / DANE)</button>
          <div class="text-xs text-gray-500">Fuentes: GeoJSON en su GitHub y, en caso de falla, DIVIPOLA DANE.</div>
          <label class="block text-sm font-semibold">URL GeoJSON Comunas de Ibagué</label>
          <input type="url" x-model="geojsonComunasUrl" placeholder="https://fundacionreaching.github.io/ibague_comunas.geojson" class="mt-1 w-full rounded-2xl border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800" />
          <label class="block text-sm font-semibold">URL GeoJSON Corregimientos de Ibagué</label>
          <input type="url" x-model="geojsonCorregUrl" placeholder="https://fundacionreaching.github.io/ibague_corregimientos.geojson" class="mt-1 w-full rounded-2xl border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800" />
          <label class="block text-sm font-semibold">URL GeoJSON Veredas de Ibagué</label>
          <input type="url" x-model="geojsonVeredasUrl" placeholder="https://fundacionreaching.github.io/ibague_veredas.geojson" class="mt-1 w-full rounded-2xl border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800" />
          <div class="grid grid-cols-2 gap-2">
            <button @click="cargarIbague()" class="w-full px-4 py-2 rounded-2xl border border-gray-300 dark:border-gray-700">Cargar Comunas/Correg./Veredas</button>
            <button @click="cargarPoblacionGit()" class="w-full px-4 py-2 rounded-2xl border border-emerald-300 text-emerald-700 dark:border-emerald-700 dark:text-emerald-300">Cargar población (GitHub)</button>
          </div>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold">Año proyección DANE</label>
            <select x-model.number="anioPoblacion" @change="reestilizarCapas()" class="mt-1 w-full rounded-2xl border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800">
              <template x-for="y in aniosPoblacion" :key="y"><option :value="y" x-text="y"></option></template>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold">Métrica</label>
            <select x-model="metrica" @change="reestilizarCapas()" class="mt-1 w-full rounded-2xl border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800">
              <option value="total">Población total</option>
              <option value="densidad">Densidad (hab/km²)</option>
            </select>
          </div>
        </div>
        <p class="text-xs mt-3 text-gray-500">Puede cargar CSV con columnas: <code>municipio,poblacion,anio,area_km2</code> o por código <code>divipola</code>.</p>
        <input type="file" accept=".csv" @change="cargarCSV($event)" class="mt-2 w-full text-sm"/>return; const text = await file.text();
          const rows = text.trim().split(/
?
/).map(r=>r.split(',')); const head = rows.shift().map(s=>s.trim().toUpperCase());
          const iNom = head.indexOf('MUNICIPIO')>-1? head.indexOf('MUNICIPIO'): head.indexOf('NOMBRE');
          const iAnio = head.indexOf('ANIO')>-1? head.indexOf('ANIO') : head.indexOf('AÑO');
          const iPob = head.indexOf('POBLACION')>-1? head.indexOf('POBLACION'): head.indexOf('POBLACIÓN');
          const iArea = head.indexOf('AREA_KM2');
          if(iNom<0 || iPob<0){ alert('CSV debe tener columnas municipio/nombre y poblacion.'); return; }
          rows.forEach(r=>{ const nom=(r[iNom]||'').toUpperCase(); this.poblacionTolima[nom] = this.poblacionTolima[nom]||{}; const an = iAnio>=0? Number(r[iAnio]): 'total'; this.poblacionTolima[nom][an]= Number(r[iPob]); if(iArea>=0) this.poblacionTolima[nom].area_km2 = Number(r[iArea]); });
          this.reestilizarCapas(); this._toast('Población actualizada (CSV)');
        }
      }))
    })
  </script>
</body>
</html>


