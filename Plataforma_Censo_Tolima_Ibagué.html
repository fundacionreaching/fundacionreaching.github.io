<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plataforma Censo — Tolima / Ibagué / Comunas / Corregimientos</title>
  <meta name="description" content="Plataforma de visualización de datos poblacionales del Tolima e Ibagué (comunas y corregimientos). Fundación Reaching." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%236366F1'/%3E%3Ctext x='50' y='58' font-size='44' text-anchor='middle' fill='white' font-family='Arial, Helvetica, sans-serif'%3ER%3C/text%3E%3C/svg%3E" />

  <!-- TailwindCSS CDN (para prototipo/HTML único) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: { 600: '#6366F1', 700: '#4F46E5' } }
        }
      }
    }
  </script>

  <!-- Leaflet (mapas) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- PapaParse (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Utilidad para descargar archivos (opcional: usamos Blob nativo) -->
  <style>
    html, body { height: 100%; }
    #map { height: 420px; }
    .leaflet-container { font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-3">
        <!-- Logo Fundación Reaching: coloca /logo-reaching.png junto a este HTML -->
        <img src="./logo-reaching.png" alt="Fundación Reaching" class="h-9 w-9 rounded-xl object-contain bg-white border border-slate-200" onerror="this.remove();document.getElementById('logo-fallback').classList.remove('hidden')" />
        <!-- Fallback si no hay archivo de logo -->
        <div id="logo-fallback" class="hidden h-9 w-9 grid place-items-center rounded-xl bg-brand-600 text-white text-sm font-bold shadow">R</div>
        <div>
          <h1 class="text-lg sm:text-xl font-extrabold tracking-tight">Plataforma Censo — Tolima / Ibagué</h1>
          <p class="text-xs text-slate-500">Fundación Reaching • Encuentro con Dios y Oración Mundial RTV</p>
        </div>
      </div>
      <div class="ml-auto hidden sm:flex items-center gap-2 text-xs text-slate-500">
        <span>“Porque del SEÑOR es la tierra y su plenitud” — Salmo 24:1</span>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-7xl px-4 py-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
    <!-- Panel izquierdo -->
    <aside class="lg:col-span-4 xl:col-span-3 space-y-4">
      <!-- Selección de capa -->
      <section class="rounded-2xl bg-white p-3 shadow-sm border border-slate-200">
        <div class="mb-2 font-semibold">Capa de datos</div>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <button data-layer="tolima" class="layer-btn rounded-xl px-3 py-2 border border-slate-300 hover:bg-slate-50 active:bg-slate-100">Tolima</button>
          <button data-layer="ibague" class="layer-btn rounded-xl px-3 py-2 border border-slate-300 hover:bg-slate-50 active:bg-slate-100">Ibagué (urbano)</button>
          <button data-layer="comunas" class="layer-btn rounded-xl px-3 py-2 border border-slate-300 hover:bg-slate-50 active:bg-slate-100">Comunas</button>
          <button data-layer="corregimientos" class="layer-btn rounded-xl px-3 py-2 border border-slate-300 hover:bg-slate-50 active:bg-slate-100">Corregimientos</button>
        </div>
        <p class="mt-2 text-xs text-slate-500">Cambia de capa para visualizar municipios del Tolima, áreas de Ibagué, comunas o corregimientos.</p>
      </section>

      <!-- Buscador y seleccionado -->
      <section class="rounded-2xl bg-white p-3 shadow-sm border border-slate-200">
        <div class="flex items-center gap-2">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          <input id="search" placeholder="Buscar municipio/sector o código…" class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-brand-600" />
        </div>
        <div id="selectedCard" class="hidden mt-3 rounded-xl bg-indigo-50 border border-indigo-200 p-3 text-sm">
          <div class="font-semibold flex items-center gap-2">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 1 1 18 0Z"/><circle cx="12" cy="10" r="3"/></svg>
            <span id="sel-name">—</span>
          </div>
          <div class="text-slate-600 mt-1">Código: <span id="sel-code" class="font-mono">—</span></div>
          <div class="text-slate-600">Población: <span id="sel-pop" class="font-semibold">—</span></div>
        </div>
      </section>

      <!-- Totales y Top 5 -->
      <div class="grid grid-cols-2 gap-3">
        <div class="rounded-2xl bg-white p-3 shadow-sm border border-slate-200">
          <div class="text-xs text-slate-500">Entidades</div>
          <div id="stat-entidades" class="mt-1 text-2xl font-extrabold">—</div>
        </div>
        <div class="rounded-2xl bg-white p-3 shadow-sm border border-slate-200">
          <div class="text-xs text-slate-500">Con dato</div>
          <div id="stat-condato" class="mt-1 text-2xl font-extrabold">—</div>
        </div>
        <div class="rounded-2xl bg-white p-3 shadow-sm border border-slate-200 col-span-2">
          <div class="text-xs text-slate-500">Población total</div>
          <div id="stat-poblacion" class="mt-1 text-2xl font-extrabold">—</div>
        </div>
      </div>

      <section class="rounded-2xl bg-white p-3 shadow-sm border border-slate-200">
        <div class="flex items-center gap-2 mb-2 font-semibold">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M7 13h8"/><path d="M7 9h12"/></svg>
          Top 5 por población
        </div>
        <ol id="top5" class="space-y-1 text-sm"></ol>
      </section>

      <button id="btn-export" class="w-full inline-flex items-center justify-center gap-2 rounded-2xl bg-brand-600 px-4 py-2 text-white text-sm font-medium shadow hover:bg-brand-700 transition">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Descargar CSV (lista actual)
      </button>

      <p class="text-xs text-slate-500 leading-relaxed">
        Fuente: archivos CSV y GeoJSON publicados por Fundación Reaching. Actualiza las rutas en la sección <code>DATA_SOURCES</code> si cambian los nombres.
      </p>
    </aside>

    <!-- Panel derecho: mapa y tabla -->
    <section class="lg:col-span-8 xl:col-span-9 space-y-4">
      <div class="relative rounded-2xl overflow-hidden bg-white shadow-sm border border-slate-200">
        <div id="map" class="w-full"></div>
        <div id="badge-layer" class="pointer-events-none absolute top-3 left-3 inline-flex items-center gap-2 rounded-xl bg-white/90 backdrop-blur px-3 py-2 text-sm shadow border border-slate-200">Capa: <span id="layer-name" class="font-semibold">—</span></div>
      </div>

      <div class="rounded-2xl bg-white shadow-sm border border-slate-200 overflow-hidden">
        <div class="px-3 py-2 border-b border-slate-200 flex items-center justify-between">
          <h3 class="font-semibold flex items-center gap-2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
            Datos por entidad
          </h3>
          <div id="rows-count" class="text-xs text-slate-500">— filas</div>
        </div>
        <div class="overflow-auto max-h-[420px]">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 sticky top-0 z-10">
              <tr>
                <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600 border-b border-slate-200 w-12">#</th>
                <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600 border-b border-slate-200">Nombre</th>
                <th class="px-3 py-2 text-left text-xs font-semibold text-slate-600 border-b border-slate-200 w-36">Código</th>
                <th class="px-3 py-2 text-right text-xs font-semibold text-slate-600 border-b border-slate-200 w-40">Población</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <footer class="mx-auto max-w-7xl px-4 pb-6 pt-2 text-xs text-slate-500">
    <p>Desarrollado con excelencia para la misión: Fundación Reaching. Bendiciones. ✨</p>
  </footer>

  <script>
    // ==============================================
    // CONFIGURACIÓN DE FUENTES DE DATOS
    // Ajusta estas rutas según los archivos publicados en tu GitHub Pages.
    // Formatos esperados:
    //  - GeoJSON: cada feature debe tener el código (DANE/propio) y el nombre en properties.
    //  - CSV: encabezados con alguna variante de: código (dane/cod/codigo), nombre (municipio/nombre/sector) y población (pob/total/habitantes).
    // ==============================================
    const DATA_SOURCES = {
      tolima: {
        label: 'Tolima — Municipios',
        center: [4.4389, -75.2322], // Ibagué
        zoom: 8,
        geojson: '/tolima_municipios.geojson',
        csv: '/dane_tolima_poblacion.csv'
      },
      ibague: {
        label: 'Ibagué — Zonas urbanas (si aplica)',
        center: [4.4389, -75.2322],
        zoom: 12,
        geojson: '/ibague_urbano.geojson', // <-- crea este archivo o actualiza la ruta
        csv: '/ibague_urbano_poblacion.csv' // <-- crea o ajusta
      },
      comunas: {
        label: 'Ibagué — Comunas',
        center: [4.4389, -75.2322],
        zoom: 12,
        geojson: '/ibague_comunas.geojson', // <-- crea este archivo o actualiza la ruta
        csv: '/ibague_comunas_poblacion.csv' // <-- crea o ajusta
      },
      corregimientos: {
        label: 'Ibagué — Corregimientos',
        center: [4.4389, -75.2322],
        zoom: 11,
        geojson: '/ibague_corregimientos.geojson', // <-- crea este archivo o actualiza la ruta
        csv: '/ibague_corregimientos_poblacion.csv' // <-- crea o ajusta
      }
    };

    // ==============================================
    // UTILIDADES
    // ==============================================
    const PALETTE = ['#e6f2ff', '#b3d1ff', '#80b1ff', '#4d91ff', '#1a70ff', '#0052cc'];

    const norm = (s) => String(s ?? '').trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
    const pad5 = (v) => String(v ?? '').replace(/\D/g, '').padStart(5, '0');

    function numberFmt(n) {
      if (n == null || isNaN(n)) return '—';
      return Number(n).toLocaleString('es-CO');
    }

    function detectColumns(keys) {
      const lower = keys.map(k => (k||'').toLowerCase());
      const findKey = (arr) => { const i = lower.findIndex(k => arr.some(a => k.includes(a))); return i>=0 ? keys[i] : null; };
      return {
        codeKey: findKey(['dane','cod','codigo','mpio','codigo_dane','coddane','cod_mun','mpio_ccdgo']),
        nameKey: findKey(['municipio','nombre','nom','sector','comuna','correg','mpio_cn','mpio_nm']),
        popKey:  findKey(['pob','pobl','habit','total'])
      };
    }

    function codeFromProps(props) {
      const candidates = [props?.MPIO_CCDGO, props?.COD_DANE, props?.Codigo, props?.codigo, props?.DANE, props?.CODIGO, props?.cod_dane, props?.CodDANE, props?.codigo_dane, props?.CODIGO_DANE, props?.CODIGO_MPIO, props?.codigo_mpio];
      for (const c of candidates) {
        const n = pad5(c);
        if (n) return n;
      }
      // fallback: si no es DANE (p.ej., comunas) devuelve string original si existe
      const anyCode = props?.CODIGO || props?.CODIGO2 || props?.ID || props?.id || props?.code || props?.Code;
      return anyCode != null ? String(anyCode) : '';
    }

    function quantile(sorted, q) {
      const pos = (sorted.length - 1) * q;
      const base = Math.floor(pos);
      const rest = pos - base;
      return sorted[base + 1] !== undefined ? sorted[base] + rest * (sorted[base+1] - sorted[base]) : sorted[base];
    }

    function makeBuckets(values, k = PALETTE.length) {
      const arr = values.filter(v => typeof v === 'number' && !isNaN(v)).sort((a,b)=>a-b);
      if (!arr.length) return { breaks: [], scale: ()=>'#cccccc' };
      const breaks = [];
      for (let i=1;i<k;i++) breaks.push(Math.round(quantile(arr, i/k)));
      const scale = (v) => {
        if (v == null || isNaN(v)) return '#cccccc';
        let idx = breaks.findIndex(b => v <= b);
        if (idx === -1) idx = k-1;
        return PALETTE[idx];
      };
      return { breaks, scale };
    }

    function downloadCSV(rows) {
      const header = ['codigo','nombre','poblacion'];
      const lines = [header.join(',')].concat(rows.map(r => [JSON.stringify(r.code), JSON.stringify(r.name), r.pop ?? ''].join(',')));
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'export_filtrado.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // ==============================================
    // ESTADO GLOBAL (simple)
    // ==============================================
    let currentKey = 'tolima';
    let map, geoLayer;
    let joined = []; // { code, name, pop, feature }

    // Inicializa mapa
    function initMap() {
      const conf = DATA_SOURCES[currentKey];
      map = L.map('map').setView(conf.center, conf.zoom);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
    }

    // Carga de datos (GeoJSON + CSV) y render
    async function loadAndRender() {
      const conf = DATA_SOURCES[currentKey];
      document.getElementById('layer-name').textContent = conf.label;

      // GeoJSON
      const geo = await fetch(conf.geojson).then(r => {
        if (!r.ok) throw new Error('No se pudo cargar GeoJSON: ' + conf.geojson);
        return r.json();
      });

      // CSV
      const csvText = await fetch(conf.csv).then(r => {
        if (!r.ok) throw new Error('No se pudo cargar CSV: ' + conf.csv);
        return r.text();
      });
      const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      const fields = parsed.meta?.fields ?? Object.keys(parsed.data[0] ?? {});
      const { codeKey, nameKey, popKey } = detectColumns(fields);

      const rows = parsed.data.map(r => {
        const code = r[codeKey];
        const name = r[nameKey];
        const popRaw = r[popKey];
        const pop = popRaw == null ? null : Number(String(popRaw).replace(/[^0-9.-]/g, ''));
        return { code: codeFromProps({ CODIGO: code, CODIGO_DANE: code, DANE: code }), name: String(name ?? '').trim(), pop: isNaN(pop) ? null : pop };
      }).filter(r => r.code || r.name);

      const byCode = new Map(rows.map(r => [String(r.code), r]));
      joined = (geo.features || []).map(f => {
        const props = f.properties || {};
        const code = String(codeFromProps(props));
        const name = props.NOMBRE || props.NOM_MPIO || props.NOMBRE_MPIO || props.Nombre || props.MUNICIPIO || props.SECTOR || props.COMUNA || props.CORREGIMIENTO || '';
        const csv = byCode.get(code) || byCode.get(pad5(code));
        return { code: code || (csv?.code ?? ''), name: String(csv?.name || name || ''), pop: csv?.pop ?? null, feature: f };
      });

      // Estadísticas
      const entidades = joined.length;
      const conDato = joined.filter(j => typeof j.pop === 'number').length;
      const poblacion = joined.reduce((acc, j) => acc + (j.pop || 0), 0);
      document.getElementById('stat-entidades').textContent = entidades;
      document.getElementById('stat-condato').textContent = conDato;
      document.getElementById('stat-poblacion').textContent = numberFmt(poblacion);

      // Top 5
      const top5 = [...joined].filter(j => j.pop).sort((a,b)=>b.pop - a.pop).slice(0,5);
      const top5El = document.getElementById('top5');
      top5El.innerHTML = '';
      top5.forEach((t,i)=>{
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between gap-2';
        li.innerHTML = `<span class="inline-flex items-center gap-2"><span class="text-slate-500 w-5">${i+1}.</span> ${t.name}</span><span class="font-medium">${numberFmt(t.pop)}</span>`;
        top5El.appendChild(li);
      });

      // Tabla
      const q = norm(document.getElementById('search').value);
      const filtered = joined.filter(j => !q || norm(j.name).includes(q) || String(j.code).includes(q));
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      filtered.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-100 hover:bg-indigo-50/40 cursor-pointer';
        tr.innerHTML = `
          <td class="px-3 py-2 text-slate-500">${i+1}</td>
          <td class="px-3 py-2 font-medium">${r.name || '(Sin nombre)'}</td>
          <td class="px-3 py-2 font-mono text-xs text-slate-600">${r.code || '—'}</td>
          <td class="px-3 py-2 text-right">${numberFmt(r.pop)}</td>`;
        tr.addEventListener('click', ()=>selectFeature(r));
        tbody.appendChild(tr);
      });
      document.getElementById('rows-count').textContent = `${filtered.length} filas`;

      // Coropletas
      const { scale } = makeBuckets(joined.map(j => j.pop).filter(Boolean));
      if (geoLayer) geoLayer.remove();
      geoLayer = L.geoJSON(geo, {
        style: (feat) => {
          const props = feat.properties || {}; const code = String(codeFromProps(props));
          const rec = joined.find(j => String(j.code) === code || pad5(String(j.code)) === pad5(code));
          const fillColor = scale(rec?.pop ?? null);
          return { weight: 1, color: '#334155', fillColor, fillOpacity: 0.85 };
        },
        onEachFeature: (feature, layer) => {
          layer.on('click', () => {
            const props = feature.properties || {}; const code = String(codeFromProps(props));
            const rec = joined.find(j => String(j.code) === code || pad5(String(j.code)) === pad5(code));
            if (rec) selectFeature(rec);
          });
          layer.on('mouseover', (e) => e.target.setStyle({ weight: 2, color: '#1f2937' }));
          layer.on('mouseout',  (e) => e.target.setStyle({ weight: 1, color: '#334155' }));
        }
      }).addTo(map);

      // Ajusta vista al conjunto
      try { map.fitBounds(geoLayer.getBounds(), { padding: [16,16] }); } catch {}
    }

    // Selección de entidad (desde mapa o tabla)
    function selectFeature(rec) {
      document.getElementById('selectedCard').classList.remove('hidden');
      document.getElementById('sel-name').textContent = rec.name || '—';
      document.getElementById('sel-code').textContent = rec.code || '—';
      document.getElementById('sel-pop').textContent = numberFmt(rec.pop);

      // Buscar capa y hacer zoom
      geoLayer.eachLayer(l => {
        const props = l.feature?.properties || {}; const code = String(codeFromProps(props));
        if (code === String(rec.code) || pad5(code) === pad5(String(rec.code))) {
          try { map.fitBounds(l.getBounds(), { padding: [20,20] }); } catch {}
        }
      });
    }

    // Eventos UI
    document.querySelectorAll('.layer-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        currentKey = btn.dataset.layer;
        document.getElementById('selectedCard').classList.add('hidden');
        await loadAndRender();
      });
    });

    document.getElementById('search').addEventListener('input', () => {
      // Re-render tabla rápida sin volver a cargar todo
      const q = norm(document.getElementById('search').value);
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      const filtered = joined.filter(j => !q || norm(j.name).includes(q) || String(j.code).includes(q));
      filtered.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-100 hover:bg-indigo-50/40 cursor-pointer';
        tr.innerHTML = `
          <td class="px-3 py-2 text-slate-500">${i+1}</td>
          <td class="px-3 py-2 font-medium">${r.name || '(Sin nombre)'}</td>
          <td class="px-3 py-2 font-mono text-xs text-slate-600">${r.code || '—'}</td>
          <td class="px-3 py-2 text-right">${numberFmt(r.pop)}</td>`;
        tr.addEventListener('click', ()=>selectFeature(r));
        tbody.appendChild(tr);
      });
      document.getElementById('rows-count').textContent = `${filtered.length} filas`;
    });

    document.getElementById('btn-export').addEventListener('click', () => {
      const q = norm(document.getElementById('search').value);
      const filtered = joined.filter(j => !q || norm(j.name).includes(q) || String(j.code).includes(q));
      downloadCSV(filtered.map(r => ({ code: r.code, name: r.name, pop: r.pop })));
    });

    // Boot
    initMap();
    loadAndRender().catch(err => {
      alert('Error cargando datos: ' + err.message + '\n\nRevisa las rutas en DATA_SOURCES.');
      console.error(err);
    });
  </script>
</body>
</html>
