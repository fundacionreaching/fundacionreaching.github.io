<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tolima ‚Äî Mapa Interactivo (v2 Mejorado)</title>
  <meta name="description" content="Mapa del Tolima con etiquetas grandes, c√≠rculos transparentes y control de intensidad del mapa. Incluye b√∫squeda, enfoque y par√°metros por URL." />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root{
      --label-font-size: 26px;         /* ?font= */
      --dot-alpha: .50;                /* ?alpha= */
      --tile-contrast: 1.25;           /* ?intensity= traduce a contraste, saturaci√≥n y brillo */
      --tile-saturate: 1.25;
      --tile-bright: 1.05;
      --bg:#0b1223; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --border:#1f2937;
      --gold:#ffd166; --azure:#60a5fa; --emerald:#10b981;
    }
    html,body{height:100%; margin:0}
    body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#0b1223;color:var(--text)}
    header{display:flex; flex-wrap:wrap; align-items:center; gap:10px; justify-content:space-between; padding:12px 14px; background:rgba(15,23,42,.9); border-bottom:1px solid var(--border)}
    h1{margin:0; font-size:18px}
    .bar{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .bar label{font-size:12px;color:var(--muted)}
    .bar input,.bar select,.bar button{background:#0b1223; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:7px 10px;}
    .bar button{cursor:pointer}
    .pill{background:#0b1223; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:#cbd5e1}
    #map{height:calc(100vh - 64px); width:100%}

    /* Etiquetas grandes, con halo para legibilidad */
    .label{font-size:var(--label-font-size); font-weight:900; letter-spacing:.3px; color:#fff; text-shadow:0 0 6px rgba(0,0,0,.8), 0 2px 12px rgba(0,0,0,.9); white-space:nowrap; pointer-events:none}
    .legend{position:absolute; right:12px; bottom:12px; background:rgba(2,6,23,.8); border:1px solid var(--border); color:#cbd5e1; border-radius:12px; padding:10px 12px; font-size:12px}
    .dot{display:inline-block; width:10px; height:10px; border-radius:999px; margin-right:6px; border:1px solid rgba(255,255,255,.35)}

    /* Pane de azulejos con filtros de intensidad */
    .tiles-filter{ filter: saturate(var(--tile-saturate)) contrast(var(--tile-contrast)) brightness(var(--tile-bright)); }
  </style>
</head>
<body>
  <header>
    <h1>üó∫Ô∏è Tolima ‚Äî Mapa Interactivo</h1>
    <div class="bar">
      <label>Letra <input id="fontCtl" type="range" min="18" max="48" step="1" value="26"/></label>
      <label>Transparencia <input id="alphaCtl" type="range" min="0.2" max="0.95" step="0.05" value="0.50"/></label>
      <label>Intensidad <input id="intCtl" type="range" min="0.8" max="1.8" step="0.05" value="1.25"/></label>
      <label>Tama√±o punto <input id="radCtl" type="range" min="6" max="20" step="1" value="10"/></label>
      <span class="pill" id="count"></span>
      <button id="fitBtn">Enfocar</button>
      <input id="search" type="text" placeholder="Buscar municipio‚Ä¶ (Enter)" style="min-width:220px"/>
    </div>
  </header>

  <div id="map" role="region" aria-label="Mapa interactivo del Tolima"></div>
  <div class="legend">
    <div><span class="dot" style="background:var(--gold)"></span> Municipios</div>
    <div><span class="dot" style="background:var(--azure)"></span> Hitos (referencia)</div>
  </div>

  <script>
    // ========= Par√°metros por URL =========
    const qs = new URLSearchParams(location.search);
    const qsFont = parseInt(qs.get('font')||'0',10);
    const qsAlpha = parseFloat(qs.get('alpha')||'0');
    const qsInt   = parseFloat(qs.get('intensity')||'0');
    const qsRad   = parseInt(qs.get('radius')||'0',10);

    // ========= Datos (Municipios y Hitos) =========
    // Coordenadas aproximadas para posicionar etiquetas; ajustar si desea precisi√≥n fina en campo.
    const MUNICIPIOS = [
      { nombre:'Ibagu√©', lat:4.4389, lng:-75.2322 },
      { nombre:'Espinal', lat:4.1498, lng:-74.8847 },
      { nombre:'Melgar', lat:4.2047, lng:-74.6400 },
      { nombre:'Honda', lat:5.2086, lng:-74.7350 },
      { nombre:'L√≠bano', lat:4.9219, lng:-75.0625 },
      { nombre:'Mariquita', lat:5.1982, lng:-74.8923 },
      { nombre:'Chaparral', lat:3.7236, lng:-75.4836 },
      { nombre:'Guamo', lat:4.0300, lng:-74.9700 },
      { nombre:'Cajamarca', lat:4.4450, lng:-75.4280 },
      { nombre:'Rovira', lat:4.2320, lng:-75.2450 },
      { nombre:'Fresno', lat:5.1525, lng:-75.0364 },
      { nombre:'Planadas', lat:3.1960, lng:-75.6450 },
      { nombre:'Natagaima', lat:3.6270, lng:-75.0960 },
      { nombre:'Purificaci√≥n', lat:3.8596, lng:-74.9322 },
      { nombre:'Salda√±a', lat:3.9300, lng:-75.0200 },
      { nombre:'Ortega', lat:3.9360, lng:-75.2200 },
      { nombre:'San Antonio', lat:3.9120, lng:-75.4870 },
      { nombre:'Coyaima', lat:3.8000, lng:-75.1900 },
      { nombre:'Ataco', lat:3.5930, lng:-75.3800 },
      { nombre:'Ambalema', lat:4.7830, lng:-74.7650 },
      { nombre:'Piedras', lat:4.5400, lng:-74.8800 },
      { nombre:'Flandes', lat:4.2440, lng:-74.8170 },
      { nombre:'Alvarado', lat:4.5665, lng:-74.9589 },
      { nombre:'Venadillo', lat:4.7193, lng:-74.9251 },
      { nombre:'Villahermosa', lat:5.0250, lng:-75.1200 },
      { nombre:'Roncesvalles', lat:4.0130, lng:-75.6070 },
      { nombre:'Anzo√°tegui', lat:4.6600, lng:-75.1000 },
      { nombre:'Palocabildo', lat:5.1190, lng:-75.0140 },
      { nombre:'Casabianca', lat:5.0790, lng:-75.1390 },
      { nombre:'Prado', lat:3.7440, lng:-74.9160 },
      { nombre:'Rioblanco', lat:3.5330, lng:-75.6800 },
      { nombre:'Dolores', lat:3.5520, lng:-74.9000 },
      { nombre:'Carmen de Apical√°', lat:4.1500, lng:-74.7200 },
      { nombre:'Coello', lat:4.4080, lng:-74.8950 },
      { nombre:'Valle de San Juan', lat:4.2000, lng:-75.1100 },
      { nombre:'Santa Isabel', lat:4.8020, lng:-75.0920 },
      { nombre:'Villarrica', lat:3.9360, lng:-74.6110 },
      { nombre:'Icononzo', lat:4.1810, lng:-74.5320 },
      { nombre:'Murillo', lat:4.8680, lng:-75.1710 },
      { nombre:'Herveo', lat:5.0810, lng:-75.1700 },
      { nombre:'Armero (Guayabal)', lat:5.0010, lng:-74.8890 },
      { nombre:'L√©rida', lat:4.8620, lng:-74.9110 }
    ];

    const HITOS = [
      { nombre:'Nevado del Tolima', lat:4.658, lng:-75.332 },
      { nombre:'Embalse de Prado', lat:3.735, lng:-74.850 }
    ];

    // ========= Mapa =========
    const map = L.map('map', { zoomControl:true, minZoom:7, maxZoom:18 });
    const CENTER = [4.25, -75.15];
    map.setView(CENTER, 8);

    // Pane con filtro para intensidad
    map.createPane('tiles');
    const tilesPane = map.getPane('tiles');
    tilesPane.classList.add('tiles-filter');
    const tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution:'¬© OpenStreetMap, Carto', subdomains:'abcd', pane:'tiles', maxZoom:20
    }).addTo(map);

    // ========= Controles =========
    const fontCtl = document.getElementById('fontCtl');
    const alphaCtl = document.getElementById('alphaCtl');
    const intCtl = document.getElementById('intCtl');
    const radCtl = document.getElementById('radCtl');
    const fitBtn = document.getElementById('fitBtn');
    const search = document.getElementById('search');
    const countEl = document.getElementById('count');

    if(qsFont) fontCtl.value = qsFont;
    if(qsAlpha) alphaCtl.value = qsAlpha;
    if(qsInt) intCtl.value = qsInt;
    if(qsRad) radCtl.value = qsRad;

    document.documentElement.style.setProperty('--label-font-size', (parseInt(fontCtl.value,10))+'px');
    document.documentElement.style.setProperty('--dot-alpha', parseFloat(alphaCtl.value));
    applyIntensity(parseFloat(intCtl.value));

    // ========= Utilidades visuales =========
    function labelHTML(text){ return `<span class="label">${text}</span>`; }
    function circle(lat, lng, color, r){
      const alpha = parseFloat(alphaCtl.value);
      // Glow suave
      const glow = L.circleMarker([lat,lng], { radius: r+4, stroke:false, fillColor: color, fillOpacity: Math.max(0, alpha*0.35) });
      // N√∫cleo
      const core = L.circleMarker([lat,lng], { radius: r, color:'rgba(255,255,255,.6)', weight:1, fillColor: color, fillOpacity: alpha });
      return { glow, core };
    }

    function featureGroupFrom(list, color){
      const g = L.featureGroup();
      const r = parseInt(radCtl.value,10);
      list.forEach(p => {
        const {glow, core} = circle(p.lat,p.lng,color,r);
        glow.addTo(g); core.addTo(g);
        const m = L.marker([p.lat,p.lng], { icon: L.divIcon({className:'', html: labelHTML(p.nombre), iconSize:[0,0]}) });
        m.addTo(g);
      });
      return g;
    }

    const LYR_MUNICIPIOS = featureGroupFrom(MUNICIPIOS, getComputedStyle(document.documentElement).getPropertyValue('--gold').trim());
    const LYR_HITOS = featureGroupFrom(HITOS, getComputedStyle(document.documentElement).getPropertyValue('--azure').trim());

    LYR_MUNICIPIOS.addTo(map);
    LYR_HITOS.addTo(map);
    countEl.textContent = `${MUNICIPIOS.length} municipios`;

    function fitAll(){
      const b = L.featureGroup([LYR_MUNICIPIOS, LYR_HITOS]).getBounds();
      map.fitBounds(b.pad(0.15));
    }
    fitAll();

    // ========= Eventos UI =========
    fontCtl.addEventListener('input', ()=>{
      const v = parseInt(fontCtl.value,10);
      document.documentElement.style.setProperty('--label-font-size', v+'px');
      syncURL('font', v);
    });
    alphaCtl.addEventListener('input', ()=>{
      const a = parseFloat(alphaCtl.value);
      document.documentElement.style.setProperty('--dot-alpha', a);
      // re-aplicar opacidad a c√≠rculos
      [LYR_MUNICIPIOS, LYR_HITOS].forEach(g=> g.eachLayer(l=> l.setStyle && l.setStyle({ fillOpacity:a })));
      syncURL('alpha', a.toFixed(2));
    });
    intCtl.addEventListener('input', ()=>{
      const i = parseFloat(intCtl.value); applyIntensity(i); syncURL('intensity', i.toFixed(2));
    });
    radCtl.addEventListener('input', ()=>{
      const r = parseInt(radCtl.value,10);
      // reconstruir capas para aplicar nuevo radio
      map.removeLayer(LYR_MUNICIPIOS); map.removeLayer(LYR_HITOS);
      const L1 = featureGroupFrom(MUNICIPIOS, getComputedStyle(document.documentElement).getPropertyValue('--gold').trim());
      const L2 = featureGroupFrom(HITOS, getComputedStyle(document.documentElement).getPropertyValue('--azure').trim());
      LYR_MUNICIPIOS.clearLayers(); LYR_HITOS.clearLayers();
      L1.eachLayer(l=> LYR_MUNICIPIOS.addLayer(l));
      L2.eachLayer(l=> LYR_HITOS.addLayer(l));
      LYR_MUNICIPIOS.addTo(map); LYR_HITOS.addTo(map);
      syncURL('radius', r);
    });

    fitBtn.addEventListener('click', fitAll);

    search.addEventListener('keydown', (e)=>{
      if(e.key !== 'Enter') return;
      const q = e.target.value.trim().toLowerCase(); if(!q) return;
      const hit = MUNICIPIOS.find(m => m.nombre.toLowerCase().includes(q));
      if(hit){ map.flyTo([hit.lat, hit.lng], 10, { duration:.9 }); }
    });

    // ========= Helpers =========
    function applyIntensity(v){
      // mapear a filtros CSS
      const contrast = v;               // 0.8 - 1.8
      const saturate = 0.9 + (v-1)*0.8; // aprox 0.7 - 1.6
      const bright   = 0.95 + (v-1)*0.3;// aprox 0.8 - 1.25
      document.documentElement.style.setProperty('--tile-contrast', contrast);
      document.documentElement.style.setProperty('--tile-saturate', saturate);
      document.documentElement.style.setProperty('--tile-bright', bright);
    }
    function syncURL(key, value){
      const u = new URL(location); u.searchParams.set(key, value); history.replaceState({},'',u);
    }
  </script>
</body>
</html>
