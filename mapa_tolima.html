<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tolima ‚Äî Mapa Interactivo (Poblaci√≥n por municipio)</title>
  <meta name="description" content="Mapa del Tolima con etiquetas grandes, c√≠rculos transparentes, control de intensidad y poblaci√≥n por municipio (Proyecci√≥n DANE 2018)." />
  <!-- 1) CSS Leaflet local (si no existe, se inyecta CDN) -->
  <link rel="stylesheet" href="assets/leaflet/leaflet.css" id="leafletCSSLocal"/>
  <style>
    :root{
      --font: 30px;        /* ?font= */
      --alpha: .55;        /* ?alpha= */
      --contrast: 1.35;    /* ?intensity= ‚Üí filtros */
      --saturate: 1.25;
      --brightness: 1.05;
      --bg:#0b1223; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --border:#1f2937;
      --gold:#ffd166; --azure:#60a5fa; --emerald:#10b981;
    }
    html,body{height:100%;margin:0}
    body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#0b1223;color:var(--text)}
    header{display:flex;flex-wrap:wrap;align-items:center;gap:10px;justify-content:space-between;padding:12px 14px;background:rgba(15,23,42,.9);border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:18px}
    .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .bar label{font-size:12px;color:var(--muted)}
    .bar input,.bar button{background:#0b1223;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:7px 10px}
    .bar button{cursor:pointer}
    .pill{background:#0b1223;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:#cbd5e1}
    #map{height:calc(100vh - 64px);width:100%}
    /* Etiqueta grande con halo y badge de poblaci√≥n */
    .label{display:inline-flex;gap:8px;align-items:center;font-size:var(--font);font-weight:900;letter-spacing:.3px;color:#fff;text-shadow:0 0 6px rgba(0,0,0,.85),0 2px 12px rgba(0,0,0,.95);white-space:nowrap;pointer-events:none}
    .badge{backdrop-filter:blur(2px);background:rgba(2,10,25,var(--alpha));border:1px solid rgba(255,255,255,.18);padding:2px 8px;border-radius:8px;font-weight:800;color:#fff}
    .legend{position:absolute;right:12px;bottom:12px;background:rgba(2,6,23,.8);border:1px solid var(--border);color:#cbd5e1;border-radius:12px;padding:10px 12px;font-size:12px}
    .dot{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px;border:1px solid rgba(255,255,255,.35)}
    .tiles-filter{filter:saturate(var(--saturate)) contrast(var(--contrast)) brightness(var(--brightness))}
    .status{display:flex;gap:10px;align-items:center;font-size:12px;color:#cbd5e1}
    .dot2{width:10px;height:10px;border-radius:999px}
    .ok{background:#22c55e}.warn{background:#f59e0b}.err{background:#ef4444}.muted{background:#94a3b8}
  </style>
  <script>
    // Si el CSS local no aplica, inyectar CDN
    document.addEventListener('DOMContentLoaded',()=>{
      const test=document.createElement('div');
      test.className='leaflet-container'; test.style.position='absolute'; test.style.left='-9999px';
      document.body.appendChild(test);
      setTimeout(()=>{
        const cs=getComputedStyle(test);
        const applied = cs.cursor==='grab' || cs.overflow==='hidden';
        if(!applied){
          const cdn=document.createElement('link');
          cdn.rel='stylesheet';
          cdn.href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css';
          document.head.appendChild(cdn);
        }
        test.remove();
      },300);
    });
  </script>
</head>
<body>
  <header>
    <h1>üó∫Ô∏è Tolima ‚Äî Municipios con poblaci√≥n (Proy. DANE 2018)</h1>
    <div class="bar">
      <label>Letra <input id="fontCtl" type="range" min="18" max="54" step="1" value="30"/></label>
      <label>Transparencia <input id="alphaCtl" type="range" min="0.2" max="0.95" step="0.05" value="0.55"/></label>
      <label>Intensidad <input id="intCtl" type="range" min="0.8" max="1.8" step="0.05" value="1.35"/></label>
      <label>Tama√±o punto <input id="radCtl" type="range" min="6" max="22" step="1" value="12"/></label>
      <input id="search" type="text" placeholder="Buscar municipio‚Ä¶ (Enter)" style="min-width:220px"/>
      <button id="fitBtn">Enfocar</button>
      <span class="pill" id="count"></span>
    </div>
    <div class="status">
      <span class="dot2 muted" id="stLeaf"></span><span id="txtLeaf">Leaflet</span>
      <span class="dot2 muted" id="stTiles"></span><span id="txtTiles">Tiles</span>
      <span class="pill" id="provider">‚Äî</span>
    </div>
  </header>

  <div id="map"></div>
  <div class="legend">
    <div><span class="dot" style="background:var(--gold)"></span> Municipios (con poblaci√≥n)</div>
    <div><span class="dot" style="background:var(--azure)"></span> Hitos (referencia)</div>
  </div>

  <!-- 2) JS Leaflet: local ‚Üí jsDelivr ‚Üí cdnjs -->
  <script>
    function injectJS(src){
      return new Promise((res,rej)=>{const s=document.createElement('script');s.src=src;s.async=true;s.onload=()=>res(true);s.onerror=()=>rej();document.head.appendChild(s)});
    }
    injectJS('assets/leaflet/leaflet.js')
      .catch(()=>injectJS('https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'))
      .catch(()=>injectJS('https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js'))
      .then(()=>{document.getElementById('stLeaf').className='dot2 ok';document.getElementById('txtLeaf').textContent='Leaflet OK';initApp();})
      .catch(()=>{document.getElementById('stLeaf').className='dot2 err';document.getElementById('txtLeaf').textContent='Leaflet FALL√ì';document.getElementById('map').innerHTML='<div style="padding:16px">No se pudo cargar Leaflet.</div>';});
  </script>

  <script>
    function applyIntensity(i){
      const contrast=i; const saturate=0.9+(i-1)*0.8; const brightness=0.95+(i-1)*0.3;
      document.documentElement.style.setProperty('--contrast',contrast);
      document.documentElement.style.setProperty('--saturate',saturate);
      document.documentElement.style.setProperty('--brightness',brightness);
    }
    function fmt(n){ try{ return Number(n).toLocaleString('es-CO'); }catch(e){ return n; } }

    function initApp(){
      const qs=new URLSearchParams(location.search);
      const FONT=parseInt(qs.get('font')||0,10)||30;
      const ALPHA=parseFloat(qs.get('alpha')||0)||0.55;
      const INT=parseFloat(qs.get('intensity')||0)||1.35;
      const RAD=parseInt(qs.get('radius')||0,10)||12;

      document.getElementById('fontCtl').value=FONT;
      document.getElementById('alphaCtl').value=ALPHA;
      document.getElementById('intCtl').value=INT;
      document.getElementById('radCtl').value=RAD;

      document.documentElement.style.setProperty('--font',FONT+'px');
      document.documentElement.style.setProperty('--alpha',ALPHA);
      applyIntensity(INT);

      const CENTER=[4.25,-75.15];
      const map=L.map('map',{zoomControl:true,minZoom:7,maxZoom:18});
      map.setView(CENTER,8);

      map.createPane('tiles');
      const pane=map.getPane('tiles'); pane.classList.add('tiles-filter');

      // Proveedores de tiles con fallback autom√°tico
      const providers=[
        {name:'OSM', url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', opts:{maxZoom:19,attribution:'¬© OpenStreetMap'}},
        {name:'OSM HOT', url:'https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', opts:{maxZoom:19,attribution:'¬© OpenStreetMap, HOT'}},
        {name:'OSM.de', url:'https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', opts:{maxZoom:19,attribution:'¬© OpenStreetMap, DE'}},
        {name:'Carto Dark', url:'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', opts:{maxZoom:20,subdomains:'abcd',attribution:'¬© OpenStreetMap, Carto'}},
      ];

      let providerIdx=0; let tiles;
      function setProvider(i){
        const p=providers[i]; if(tiles){ map.removeLayer(tiles); }
        tiles=L.tileLayer(p.url,Object.assign({pane:'tiles'},p.opts)).addTo(map);
        document.getElementById('provider').textContent=p.name;
        document.getElementById('stTiles').className='dot2 ok';
        document.getElementById('txtTiles').textContent='Tiles OK';
        tiles.on('tileerror',()=>{
          if(providerIdx<providers.length-1){
            providerIdx++; document.getElementById('stTiles').className='dot2 warn'; document.getElementById('txtTiles').textContent='Cambiando tiles‚Ä¶'; setProvider(providerIdx);
          }else{
            document.getElementById('stTiles').className='dot2 err'; document.getElementById('txtTiles').textContent='Tiles FALLARON';
          }
        });
      }
      setProvider(providerIdx);

      // ===== Datos: Municipios (lat,lng,pob) Fuente: Proyecci√≥n DANE 2018 (divulgada por TodaColombia) =====
      const M=[
        {nombre:'Ibagu√©',lat:4.4389,lng:-75.2322,pob:558815},
        {nombre:'Alpujarra',lat:3.39103,lng:-74.93260,pob:4974},
        {nombre:'Alvarado',lat:4.5665,lng:-74.9589,pob:8816},
        {nombre:'Ambalema',lat:4.783,lng:-74.765,pob:6755},
        {nombre:'Anzo√°tegui',lat:4.66,lng:-75.1,pob:18638},
        {nombre:'Armero (Guayabal)',lat:5.001,lng:-74.889,pob:11839},
        {nombre:'Ataco',lat:3.593,lng:-75.38,pob:22589},
        {nombre:'Cajamarca',lat:4.445,lng:-75.428,pob:19641},
        {nombre:'Carmen de Apical√°',lat:4.15,lng:-74.72,pob:8835},
        {nombre:'Casabianca',lat:5.079,lng:-75.139,pob:6661},
        {nombre:'Chaparral',lat:3.7236,lng:-75.4836,pob:47248},
        {nombre:'Coello',lat:4.408,lng:-74.895,pob:9810},
        {nombre:'Coyaima',lat:3.8,lng:-75.19,pob:28335},
        {nombre:'Cunday',lat:4.06083,lng:-74.69417,pob:9634},
        {nombre:'Dolores',lat:3.552,lng:-74.9,pob:8015},
        {nombre:'Espinal',lat:4.1498,lng:-74.8847,pob:76149},
        {nombre:'Falan',lat:5.12361,lng:-74.95167,pob:9211},
        {nombre:'Flandes',lat:4.244,lng:-74.817,pob:29199},
        {nombre:'Fresno',lat:5.1525,lng:-75.0364,pob:30165},
        {nombre:'Guamo',lat:4.03,lng:-74.97,pob:32113},
        {nombre:'Herveo',lat:5.081,lng:-75.17,pob:8008},
        {nombre:'Honda',lat:5.2086,lng:-74.735,pob:24547},
        {nombre:'Icononzo',lat:4.181,lng:-74.532,pob:10894},
        {nombre:'L√©rida',lat:4.862,lng:-74.911,pob:17395},
        {nombre:'L√≠bano',lat:4.9219,lng:-75.0625,pob:40266},
        {nombre:'Mariquita',lat:5.1982,lng:-74.8923,pob:33329},
        {nombre:'Melgar',lat:4.2047,lng:-74.64,pob:36339},
        {nombre:'Murillo',lat:4.868,lng:-75.171,pob:5018},
        {nombre:'Natagaima',lat:3.627,lng:-75.096,pob:22516},
        {nombre:'Ortega',lat:3.936,lng:-75.22,pob:32431},
        {nombre:'Palocabildo',lat:5.119,lng:-75.014,pob:9160},
        {nombre:'Piedras',lat:4.54,lng:-74.88,pob:5640},
        {nombre:'Planadas',lat:3.196,lng:-75.645,pob:29974},
        {nombre:'Prado',lat:3.744,lng:-74.916,pob:7701},
        {nombre:'Purificaci√≥n',lat:3.8596,lng:-74.9322,pob:29412},
        {nombre:'Rioblanco',lat:3.533,lng:-75.68,pob:24459},
        {nombre:'Roncesvalles',lat:4.013,lng:-75.607,pob:6344},
        {nombre:'Rovira',lat:4.232,lng:-75.245,pob:20542},
        {nombre:'Salda√±a',lat:3.93,lng:-75.02,pob:14385},
        {nombre:'San Antonio',lat:3.912,lng:-75.487,pob:14310},
        {nombre:'San Luis',lat:4.13414,lng:-75.09470,pob:19153},
        {nombre:'Santa Isabel',lat:4.802,lng:-75.092,pob:6357},
        {nombre:'Su√°rez',lat:4.04818,lng:-74.8319,pob:4547},
        {nombre:'Valle de San Juan',lat:4.2,lng:-75.11,pob:6368},
        {nombre:'Venadillo',lat:4.7193,lng:-74.9251,pob:19652},
        {nombre:'Villahermosa',lat:5.025,lng:-75.12,pob:10642},
        {nombre:'Villarrica',lat:3.936,lng:-74.611,pob:5389}
      ];

      const HITOS=[{nombre:'Nevado del Tolima',lat:4.658,lng:-75.332},{nombre:'Embalse de Prado',lat:3.735,lng:-74.85}];

      function labelHTML(n,p){return `<span class="label"><span>${n}</span><span class="badge">Pobl: ${fmt(p)}</span></span>`}
      function circle(lat,lng,color,r){
        const a=parseFloat(document.getElementById('alphaCtl').value);
        const glow=L.circleMarker([lat,lng],{radius:r+4,stroke:false,fillColor:color,fillOpacity:Math.max(0,a*0.35)});
        const core=L.circleMarker([lat,lng],{radius:r,color:'rgba(255,255,255,.6)',weight:1,fillColor:color,fillOpacity:a});
        return {glow,core};
      }
      function groupFrom(list,color){
        const g=L.featureGroup(); const r=parseInt(document.getElementById('radCtl').value,10);
        list.forEach(p=>{const {glow,core}=circle(p.lat,p.lng,color,r); glow.addTo(g); core.addTo(g); L.marker([p.lat,p.lng],{icon:L.divIcon({className:'',html:labelHTML(p.nombre,p.pob),iconSize:[0,0]})}).addTo(g)});
        return g;
      }
      const gold=getComputedStyle(document.documentElement).getPropertyValue('--gold').trim();
      const azure=getComputedStyle(document.documentElement).getPropertyValue('--azure').trim();
      const LYR_MUN=groupFrom(M, gold);
      const LYR_HIT=groupFrom(HITOS, azure);
      LYR_MUN.addTo(map); LYR_HIT.addTo(map);
      document.getElementById('count').textContent=`${M.length} municipios`;

      function fitAll(){ const b=L.featureGroup([LYR_MUN,LYR_HIT]).getBounds(); map.fitBounds(b.pad(0.15)); }
      fitAll();

      // Controles
      const fontCtl=document.getElementById('fontCtl');
      const alphaCtl=document.getElementById('alphaCtl');
      const intCtl=document.getElementById('intCtl');
      const radCtl=document.getElementById('radCtl');
      const fitBtn=document.getElementById('fitBtn');
      const search=document.getElementById('search');

      fontCtl.addEventListener('input',()=>{const v=parseInt(fontCtl.value,10);document.documentElement.style.setProperty('--font',v+'px'); sync('font',v)});
      alphaCtl.addEventListener('input',()=>{const a=parseFloat(alphaCtl.value);document.documentElement.style.setProperty('--alpha',a);[LYR_MUN,LYR_HIT].forEach(g=>g.eachLayer(l=>l.setStyle&&l.setStyle({fillOpacity:a}))); sync('alpha',a.toFixed(2))});
      intCtl.addEventListener('input',()=>{const i=parseFloat(intCtl.value);applyIntensity(i);sync('intensity',i.toFixed(2))});
      radCtl.addEventListener('input',()=>{const r=parseInt(radCtl.value,10); map.removeLayer(LYR_MUN); map.removeLayer(LYR_HIT); const L1=groupFrom(M,gold); const L2=groupFrom(HITOS,azure); LYR_MUN.clearLayers(); LYR_HIT.clearLayers(); L1.eachLayer(l=>LYR_MUN.addLayer(l)); L2.eachLayer(l=>LYR_HIT.addLayer(l)); LYR_MUN.addTo(map); LYR_HIT.addTo(map); sync('radius',r)});
      fitBtn.addEventListener('click',fitAll);
      search.addEventListener('keydown',e=>{ if(e.key!=='Enter')return;const q=e.target.value.trim().toLowerCase(); if(!q)return; const hit=M.find(m=>m.nombre.toLowerCase().includes(q)); if(hit){ map.flyTo([hit.lat,hit.lng],10,{duration:.9}); }});

      function sync(k,v){ const u=new URL(location); u.searchParams.set(k,v); history.replaceState({},'',u); }
    }
  </script>
</body>
</html>
